(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{327:function(t,e,a){"use strict";a.r(e);var r=a(0),s=Object(r.a)({},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Flutter版本：1.9.1\nFlutterBoost版本：1.9.1\n测试使用的iamge_picker版本：0.6.2+2\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("Flutter Boost 目前算是 Flutter 混合开发的一个旗帜了，不过也由于 Flutter 技术本身就较新，Flutter Boost 也才开源一年多时间，里面还是会存在较多 bug。我们公司使用的就是 Flutter Boost 集成的混合开发项目，这几天集成选择相册的功能，本地开发没问题，通过 Flutter Boost 集成到原生后 Android 端第一次跳转后返回接收不到参数，由于接收不到参数，第二次点击就没响应了，报错"),a("code",[t._v("Unhandled Exception: PlatformException(already_active, Image picker is already active, null)")]),t._v("，iOS 就根本跳转不了。我也花了点时间 debug，发现了其中的问题。")]),t._v(" "),a("h2",{attrs:{id:"android-端解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#android-端解决方案","aria-hidden":"true"}},[t._v("#")]),t._v(" Android 端解决方案")]),t._v(" "),a("h3",{attrs:{id:"问题原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题原因","aria-hidden":"true"}},[t._v("#")]),t._v(" 问题原因")]),t._v(" "),a("ul",[a("li",[t._v("集成 flutter_boost 之后，很多插件会使用栈底的 Activity，也就是 app 启动的时候的 MainActivity()（app 启动的时候会注册插件，插件通过 registrar.activity()获取到的）")]),t._v(" "),a("li",[t._v("Android 使用底层 Activity 跳转没问题，但是调用 startActivityForResult 的时候，需要使用在栈顶的 Activity（onResume 状态的 Activity）才会在拉起的界面 finish 的时候拿到回调，这就会导致我们使用的插件中的 Activity 拿不到回调")])]),t._v(" "),a("h3",{attrs:{id:"我的解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#我的解决方案","aria-hidden":"true"}},[t._v("#")]),t._v(" 我的解决方案")]),t._v(" "),a("ol",[a("li",[t._v("修改插件源码，在插件里面注册 Activity 的生命周期回调,并修改 Activity 指向")])]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("android/src/main/java/io/flutter/plugins/imagepicker/ImagePickerPlugin.java")]),t._v("中本身就有 Activity 生命周期注册：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("70- public void onActivityResumed(Activity activity) {}\n70+ public void onActivityResumed(Activity activity) {\n71+    delegate.changeActivity(activity);\n72+}\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("2.在"),a("code",[t._v("android/src/main/java/io/flutter/plugins/imagepicker/ImagePickerDelegate.java")]),t._v("中需要把原来 final 的 activity 改为动态的")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("80-  private final Activity activity;\n80+  private Activity activity;\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("然后添加更新函数")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("public void changeActivity(Activity activity) {\n    this.activity=activity;\n}\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("ok,这个时候在调用 startActivityForResult 的时候会使用这个改过的 Activity 的实例，在拉起的 Activity finish 的时候，就能顺利拿到回调了。")]),t._v(" "),a("h2",{attrs:{id:"ios-端解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ios-端解决方案","aria-hidden":"true"}},[t._v("#")]),t._v(" iOS 端解决方案")]),t._v(" "),a("h3",{attrs:{id:"问题原因-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题原因-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 问题原因")]),t._v(" "),a("p",[t._v("iOS 其实跟 Android 端的问题大同小异，注册的时候是使用的底层的 controller，所以我们在 FlutterController 中使用这个底层的 controller 无法跳转")]),t._v(" "),a("h3",{attrs:{id:"我的解决方案-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#我的解决方案-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 我的解决方案")]),t._v(" "),a("ol",[a("li",[t._v("添加一个能拿到顶层 controller 的方法\n"),a("code",[t._v("ios/Classes/ImagePickerPlugin.m")])])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("- (UIViewController *)getCurrentVC\n{\n    UIViewController *rootViewController = [UIApplication sharedApplication].keyWindow.rootViewController;\n    UIViewController *currentVC = [self getCurrentVCFrom:rootViewController];\n    return currentVC;\n}\n\n- (UIViewController *)getCurrentVCFrom:(UIViewController *)rootVC\n{\n    UIViewController *currentVC;\n    if ([rootVC presentedViewController]) {\n        // 视图是被presented出来的\n        rootVC = [rootVC presentedViewController];\n    }\n    if ([rootVC isKindOfClass:[UITabBarController class]]) {\n        // 根视图为UITabBarController\n        currentVC = [self getCurrentVCFrom:[(UITabBarController *)rootVC selectedViewController]];\n\n    } else if ([rootVC isKindOfClass:[UINavigationController class]]){\n        // 根视图为UINavigationController\n        currentVC = [self getCurrentVCFrom:[(UINavigationController *)rootVC visibleViewController]];\n    } else {\n        // 根视图为非导航类\n        currentVC = rootVC;\n    }\n    return currentVC;\n}\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("在我们点击 image_picker 发送通道消息的时候更改本地已缓存的 controller")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("57+ UIViewController *rootViewController = [UIApplication  sharedApplication].keyWindow.rootViewController;\n58+ _viewController  = [self getCurrentVCFrom:rootViewController];\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("问题解决")]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("我这里这两种方案不会是最好的解决方案，因为涉及到改插件源码，这样以后插件更新会比较麻烦，但是从目前看来是解决了我开发的问题，如果你们有好的解决方案，或者新版本已经解决了这个问题，请留言告知。")])])},[],!1,null,null,null);e.default=s.exports}}]);