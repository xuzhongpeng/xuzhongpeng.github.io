<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Flutter中的键盘事件 | 幺风</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.da10bf32.css" as="style"><link rel="preload" href="/assets/js/app.f735c987.js" as="script"><link rel="preload" href="/assets/js/4.1b5f1a26.js" as="script"><link rel="preload" href="/assets/js/3.7354cf96.js" as="script"><link rel="preload" href="/assets/js/38.5cf11128.js" as="script"><link rel="prefetch" href="/assets/js/1.91feba10.js"><link rel="prefetch" href="/assets/js/10.c31bcc1b.js"><link rel="prefetch" href="/assets/js/11.642edadc.js"><link rel="prefetch" href="/assets/js/12.e9bb10d9.js"><link rel="prefetch" href="/assets/js/13.bdd95be6.js"><link rel="prefetch" href="/assets/js/14.b6c81b34.js"><link rel="prefetch" href="/assets/js/15.b5139249.js"><link rel="prefetch" href="/assets/js/16.1ade8e0c.js"><link rel="prefetch" href="/assets/js/17.f0b30fb5.js"><link rel="prefetch" href="/assets/js/18.1c883b67.js"><link rel="prefetch" href="/assets/js/19.3e639663.js"><link rel="prefetch" href="/assets/js/20.74962acf.js"><link rel="prefetch" href="/assets/js/21.f837615d.js"><link rel="prefetch" href="/assets/js/22.933fde40.js"><link rel="prefetch" href="/assets/js/23.9334c5ee.js"><link rel="prefetch" href="/assets/js/24.ef408fc2.js"><link rel="prefetch" href="/assets/js/25.f9800b90.js"><link rel="prefetch" href="/assets/js/26.f56ce7bf.js"><link rel="prefetch" href="/assets/js/27.267e0efb.js"><link rel="prefetch" href="/assets/js/28.1aafaa74.js"><link rel="prefetch" href="/assets/js/29.bf71bb2d.js"><link rel="prefetch" href="/assets/js/30.65608550.js"><link rel="prefetch" href="/assets/js/31.c5de1bf4.js"><link rel="prefetch" href="/assets/js/32.43ee74a8.js"><link rel="prefetch" href="/assets/js/33.1efff8a5.js"><link rel="prefetch" href="/assets/js/34.89d049a4.js"><link rel="prefetch" href="/assets/js/35.6b5e7256.js"><link rel="prefetch" href="/assets/js/36.1be005db.js"><link rel="prefetch" href="/assets/js/37.db62ff97.js"><link rel="prefetch" href="/assets/js/39.fa355553.js"><link rel="prefetch" href="/assets/js/40.7490c5e3.js"><link rel="prefetch" href="/assets/js/41.4e813bfa.js"><link rel="prefetch" href="/assets/js/42.93650a8e.js"><link rel="prefetch" href="/assets/js/43.9f1ac82d.js"><link rel="prefetch" href="/assets/js/44.bd781139.js"><link rel="prefetch" href="/assets/js/45.2c5e635b.js"><link rel="prefetch" href="/assets/js/46.50f53b28.js"><link rel="prefetch" href="/assets/js/47.5478a007.js"><link rel="prefetch" href="/assets/js/48.ec71092b.js"><link rel="prefetch" href="/assets/js/49.f17a1618.js"><link rel="prefetch" href="/assets/js/5.4c86b808.js"><link rel="prefetch" href="/assets/js/50.b1e9909e.js"><link rel="prefetch" href="/assets/js/51.777f406a.js"><link rel="prefetch" href="/assets/js/52.f3a47314.js"><link rel="prefetch" href="/assets/js/53.8bda39e8.js"><link rel="prefetch" href="/assets/js/54.6bdd66b2.js"><link rel="prefetch" href="/assets/js/55.d3af29b9.js"><link rel="prefetch" href="/assets/js/56.5e98aed3.js"><link rel="prefetch" href="/assets/js/57.8fac4797.js"><link rel="prefetch" href="/assets/js/58.1f764b7f.js"><link rel="prefetch" href="/assets/js/59.cd677a6a.js"><link rel="prefetch" href="/assets/js/6.d79a3977.js"><link rel="prefetch" href="/assets/js/60.83d74725.js"><link rel="prefetch" href="/assets/js/61.e61ccd9b.js"><link rel="prefetch" href="/assets/js/62.444cc809.js"><link rel="prefetch" href="/assets/js/63.157bbc00.js"><link rel="prefetch" href="/assets/js/64.2ec80c70.js"><link rel="prefetch" href="/assets/js/65.d35a0001.js"><link rel="prefetch" href="/assets/js/66.6f92e582.js"><link rel="prefetch" href="/assets/js/67.9d51e14d.js"><link rel="prefetch" href="/assets/js/68.5675c3e2.js"><link rel="prefetch" href="/assets/js/69.e536d7ac.js"><link rel="prefetch" href="/assets/js/7.0dcc7463.js"><link rel="prefetch" href="/assets/js/70.e187963b.js"><link rel="prefetch" href="/assets/js/71.09bda95d.js"><link rel="prefetch" href="/assets/js/72.aefd789f.js"><link rel="prefetch" href="/assets/js/73.20936a8d.js"><link rel="prefetch" href="/assets/js/74.d17921e6.js"><link rel="prefetch" href="/assets/js/75.0ff9c5e9.js"><link rel="prefetch" href="/assets/js/76.479d210c.js"><link rel="prefetch" href="/assets/js/77.c5443f0d.js"><link rel="prefetch" href="/assets/js/78.666b2fe9.js"><link rel="prefetch" href="/assets/js/79.949a1f44.js"><link rel="prefetch" href="/assets/js/8.67e8e6f2.js"><link rel="prefetch" href="/assets/js/9.70c87633.js">
    <link rel="stylesheet" href="/assets/css/0.styles.da10bf32.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container reform"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="幺风" class="logo"> <span class="site-name can-hide">幺风</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><span class="reform-jia" style="font-size:1rem;"></span>
主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-zhi"></span> <span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link"><!---->
前端</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/" class="nav-link router-link-active"><!---->
Flutter</a></li><li class="dropdown-item"><!----> <a href="/blog/coding/" class="nav-link"><!---->
学习思考</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/" class="nav-link"><!---->
算法与数据结构</a></li><li class="dropdown-item"><!----> <a href="/blog/reading/" class="nav-link"><!---->
阅读笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/reflection/" class="nav-link"><!---->
思考</a></li><li class="dropdown-item"><!----> <a href="/blog/canvas/" class="nav-link"><!---->
渲染相关</a></li><li class="dropdown-item"><!----> <a href="/blog/gesture/" class="nav-link"><!---->
事件相关</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-shuben"></span> <span class="title">文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/vuepress-theme-reform.html" class="nav-link"><!---->
vuepress-theme-reform</a></li><li class="dropdown-item"><!----> <a href="/document/弹幕插件文档.html" class="nav-link"><!---->
弹幕插件文档</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><!---->
标签云</a></div><div class="nav-item"><a href="/about/" class="nav-link"><!---->
关于我</a></div> <a href="https://github.com/xuzhongpeng" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><span class="reform-jia" style="font-size:1rem;"></span>
主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-zhi"></span> <span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link"><!---->
前端</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/" class="nav-link router-link-active"><!---->
Flutter</a></li><li class="dropdown-item"><!----> <a href="/blog/coding/" class="nav-link"><!---->
学习思考</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/" class="nav-link"><!---->
算法与数据结构</a></li><li class="dropdown-item"><!----> <a href="/blog/reading/" class="nav-link"><!---->
阅读笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/reflection/" class="nav-link"><!---->
思考</a></li><li class="dropdown-item"><!----> <a href="/blog/canvas/" class="nav-link"><!---->
渲染相关</a></li><li class="dropdown-item"><!----> <a href="/blog/gesture/" class="nav-link"><!---->
事件相关</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-shuben"></span> <span class="title">文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/vuepress-theme-reform.html" class="nav-link"><!---->
vuepress-theme-reform</a></li><li class="dropdown-item"><!----> <a href="/document/弹幕插件文档.html" class="nav-link"><!---->
弹幕插件文档</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><!---->
标签云</a></div><div class="nav-item"><a href="/about/" class="nav-link"><!---->
关于我</a></div> <a href="https://github.com/xuzhongpeng" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Flutter中的键盘事件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#键盘事件类型" class="sidebar-link">键盘事件类型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#键盘事件入口及监听方法" class="sidebar-link">键盘事件入口及监听方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#keyeventmanager" class="sidebar-link">KeyEventManager</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#hardwarekeyboard" class="sidebar-link">HardwareKeyboard</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#焦点系统（focus）" class="sidebar-link">焦点系统（Focus）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#focus" class="sidebar-link">Focus</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#focusnode" class="sidebar-link">FocusNode</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#focusscope-focusscopenode" class="sidebar-link">FocusScope &amp; FocusScopeNode</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#focusmanager" class="sidebar-link">FocusManager</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#focustraversalgroup-focustraversalpolicy" class="sidebar-link">FocusTraversalGroup &amp; FocusTraversalPolicy</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#其它关键类" class="sidebar-link">其它关键类</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#完整链路梳理" class="sidebar-link">完整链路梳理</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#小结-2" class="sidebar-link">小结</a></li></ul></li><li><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#快捷键（shortcuts）" class="sidebar-link">快捷键（Shortcuts）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#callbackshortcuts" class="sidebar-link">CallbackShortcuts</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#shortcutactivator" class="sidebar-link">ShortcutActivator</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#shortcuts-actions" class="sidebar-link">Shortcuts &amp; Actions</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#shortcuts" class="sidebar-link">Shortcuts</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#actions" class="sidebar-link">Actions</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#已有的-intent-action" class="sidebar-link">已有的 Intent &amp; Action</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#示例" class="sidebar-link">示例</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#小结-3" class="sidebar-link">小结</a></li></ul></li><li><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter%E4%B8%AD%E7%9A%84%E9%94%AE%E7%9B%98%E4%BA%8B%E4%BB%B6.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page" data-v-8958e280> <section class="tags" data-v-8958e280><span class="tagPopup" data-v-8958e280><a href="/tags/?tag=Flutter" class="tag" data-v-8958e280>Flutter</a></span><span class="tagPopup" data-v-8958e280><a href="/tags/?tag=Dart" class="tag" data-v-8958e280>Dart</a></span><span class="tagPopup" data-v-8958e280><a href="/tags/?tag=Flutter%E4%BA%8B%E4%BB%B6" class="tag" data-v-8958e280>Flutter事件</a></span></section> <div class="content theme-default-content content__default" data-v-8958e280><p>键盘操作是计算机与人交互非常重要的一环，大部分优秀的软件都集成很多优秀的快捷键，甚至有些软件能做到使用键盘不使用鼠标就能完成整个软件的操作及使用，所以掌握软件中的键盘事件原理也是一个软件开发者的必修课，Flutter中提供了完善的事件传递及处理的方法，下面带大家学习一下。<code>本篇幅较长，如果不想看细节和原理分析，可以直接看中间各个小结及总结部分</code>。</p> <h2 id="键盘事件类型"><a href="#键盘事件类型" aria-hidden="true" class="header-anchor">#</a> 键盘事件类型</h2> <p>Flutter中事件有两种类型<code>PhysicalKeyboardKey</code>和<code>LogicalKeyboardKey</code></p> <ul><li>PhysicalKeyboardKey（物理键）：</li></ul> <p>顾名思义，PhysicalKeyboardKey表示键盘上的物理位置。它不考虑当前的键盘布局、输入语言或修饰键状态（如Shift或Alt）。Flutter在<code>PhysicalKeyboardKey</code>类上提供了几乎覆盖所有按键的静态方法，可以通过如<code>PhysicalKeyboardKey.keyA</code>表示<code>A</code>键。</p> <ul><li>LogicalKeyboardKey（逻辑键）：</li></ul> <p>LogicalKeyboardKey则是在当前的键盘布局、输入语言和修饰键状态下的逻辑解释。它考虑了当前环境，因此同一个物理键在不同情况下可能对应不同的逻辑键。同上Flutter也在<code>LogicalKeyboardKey</code>上提供了所有按键的静态方法，如<code>LogicalKeyboardKey.keyA</code>表示<code>A</code>键。</p> <p>例如，如果你想要实现一个应用，其中按下&quot;Q&quot;键退出某个功能，你应该查看<code>LogicalKeyboardKey</code>来检测这个，因为你想让它匹配标有&quot;Q&quot;的键，而不是总是查找&quot;在TAB键旁边的那个键&quot;，因为在法式键盘上，&quot;A&quot;键位于TAB键旁边。相反，如果在你的游戏中，你希望CAPS LOCK键旁边的那个键（在QWERTY键盘上是&quot;A&quot;键）使玩家向左移动，你应该查看物理键，以确保无论该键产生什么字符，都能识别出键盘上那个位置的键。</p> <p>如果要比较键值，我们可以通过<code>PhysicalKeyboardKey</code>和<code>LogicalKeyboardKey</code>上的静态属性来和按下的键进行比较，比如判断我当前按下了<code>Q</code>，可以通过<code>event.logiclKey == LogicalKeyboardKey.keyQ</code>判断。</p> <h2 id="键盘事件入口及监听方法"><a href="#键盘事件入口及监听方法" aria-hidden="true" class="header-anchor">#</a> 键盘事件入口及监听方法</h2> <blockquote><p>packages/flutter/lib/src/services/binding.dart</p></blockquote> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>platformDispatcher<span class="token punctuation">.</span>onKeyData <span class="token operator">=</span> _keyEventManager<span class="token punctuation">.</span>handleKeyData<span class="token punctuation">;</span>
SystemChannels<span class="token punctuation">.</span>keyEvent<span class="token punctuation">.</span><span class="token function">setMessageHandler</span><span class="token punctuation">(</span>_keyEventManager<span class="token punctuation">.</span>handleRawKeyMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>键盘事件系统当前有两种触发入口，一个是<code>onKeyData</code>一个是<code>SystemChannels.keyEvent</code>。原因解释可以看这几个官方解释</p> <ul><li><a href="https://docs.google.com/document/u/0/d/1FDuxxEh810XpY561SgeiyUR0gU2eVz5kRpCFI55ibec/mobilebasic?pli=1" target="_blank" rel="noopener noreferrer">Platform-based Key Events<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/flutter/flutter/issues/132433" target="_blank" rel="noopener noreferrer">FlutterEngineSendKeyEvent only sends message to the flutter/keydata channel after a flutter/keyevent message<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/flutter/flutter/pull/132533/files" target="_blank" rel="noopener noreferrer">KeyEventManager解释<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/flutter/engine/pull/23466" target="_blank" rel="noopener noreferrer">Hardware keyboard: Web, embedder, and dart:ui<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <p>简单解释是为了更好适配不同平台主要是PC端平台，Flutter新设计了<code>onKeyData</code>的事件方式，但是一时半会删除不了<code>keyEvent</code>的方式，所以设计了<code>KeyEventManager</code>类进行抹平两个事件通知的差异，不过到目前为止，官方的Embedded还没有使用过<code>onKeyData</code>方式来集成，所以本文的所有分析都建立在<code>keyEvent</code>方式。</p> <p>多提一点，老的<code>keyEvent</code>是通过向<code>flutter/keyevent</code>这个BasicMessageChannel通道发送消息的方式进行集成，新的<code>onKeyData</code>是通过调用<code>FlutterEngineSendKeyEvent</code>的方式进行集成。</p> <h3 id="keyeventmanager"><a href="#keyeventmanager" aria-hidden="true" class="header-anchor">#</a> KeyEventManager</h3> <p><code>KeyEventManager</code>提供两个入参<code>_hardwareKeyboard</code>以及<code>_rawKeyboard</code>，前者(HardwareKeyboard)是新的键盘事件管理器，提供更加规范的事件协议，后者(RawKeyboard)是老的事件管理器。</p> <p><code>keyMessageHandler</code>，当键盘事件触发时会执行此函数，可以通过<code>ServicesBinding.instance.keyEventManager.keyMessageHandler = handleKeyMessage</code>来绑定，但是一般不推荐通过此方式绑定，因为目前事件绑定在<code>FocusManager</code>，如果其它地方绑定后会导致Focus相关的事件接收失效。</p> <p>当键盘事件发生时，原始函数在进行一系列处理后，会通过<code>keyMessageHandler</code>进行分发，同时也会触发<code>_hardwareKeyboard</code>响应。</p> <p><code>onKeyData</code>回调触发源码如下</p> <blockquote><p>packages/flutter/lib/src/services/hardware_keyboard.dart</p></blockquote> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">//...</span>
  bool <span class="token function">handleKeyData</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>KeyData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _transitMode <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> KeyDataTransitMode<span class="token punctuation">.</span>keyDataThenRawKeyData<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>_transitMode<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> KeyDataTransitMode<span class="token punctuation">.</span>rawKeyData<span class="token punctuation">:</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'Should never encounter KeyData when transitMode is rawKeyData.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> KeyDataTransitMode<span class="token punctuation">.</span>keyDataThenRawKeyData<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>physical <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>logical <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>physical <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>logical <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> KeyEvent event <span class="token operator">=</span> <span class="token function">_eventFromData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>synthesized <span class="token operator">&amp;&amp;</span> _keyEventsSinceLastMessage<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 触发[HardwareKeyboard]中的事件监听回调</span>
          _hardwareKeyboard<span class="token punctuation">.</span><span class="token function">handleKeyEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 触发[keyMessageHandler]中的事件监听回调</span>
          <span class="token function">_dispatchKeyMessage</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>KeyEvent<span class="token operator">&gt;</span><span class="token punctuation">[</span>event<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          _keyEventsSinceLastMessage<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token comment">//...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>新的事件系统中不会触发<code>_rawKeyboard</code>的回调，所以通过<code>RawKeyboard.instance.addListener</code>监听的键盘事件新系统中不会有响应。<code>_hardwareKeyboard.handleKeyEvent(event)</code>会触发<code>HardwareKeyboard</code>里的监听回调，<code>_dispatchKeyMessage</code>触发<code>keyMessageHandler</code>事件监听回调，其中<code>keyMessageHandler</code>会被<code>FocusManager</code>注册消费。</p> <p><code>handleRawKeyMessage</code></p> <blockquote><p>packages/flutter/lib/src/services/hardware_keyboard.dart</p></blockquote> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">//...</span>
Future<span class="token operator">&lt;</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token operator">&gt;&gt;</span> <span class="token function">handleRawKeyMessage</span><span class="token punctuation">(</span><span class="token keyword">dynamic</span> message<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_transitMode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _transitMode <span class="token operator">=</span> KeyDataTransitMode<span class="token punctuation">.</span>rawKeyData<span class="token punctuation">;</span>
      <span class="token comment">// 触发_rawKeyboard的监听回调</span>
      _rawKeyboard<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>_convertRawEventAndStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> RawKeyEvent rawEvent <span class="token operator">=</span> RawKeyEvent<span class="token punctuation">.</span><span class="token function">fromMessage</span><span class="token punctuation">(</span>message <span class="token operator">as</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool shouldDispatch <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 特殊处理键盘按下和抬起事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rawEvent <span class="token operator">is</span> RawKeyDownEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rawEvent<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">shouldDispatchEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shouldDispatch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        _skippedRawKeysPressed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rawEvent<span class="token punctuation">.</span>physicalKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        _skippedRawKeysPressed<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>rawEvent<span class="token punctuation">.</span>physicalKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rawEvent <span class="token operator">is</span> RawKeyUpEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_skippedRawKeysPressed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>rawEvent<span class="token punctuation">.</span>physicalKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _skippedRawKeysPressed<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>rawEvent<span class="token punctuation">.</span>physicalKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        shouldDispatch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    bool handled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldDispatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 触发[RawKeyboard]的监听回调</span>
      handled <span class="token operator">=</span> _rawKeyboard<span class="token punctuation">.</span><span class="token function">handleRawKeyEvent</span><span class="token punctuation">(</span>rawEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> KeyEvent event <span class="token keyword">in</span> _keyEventsSinceLastMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 触发[HardwareKeyboard]事件监听回调</span>
        handled <span class="token operator">=</span> _hardwareKeyboard<span class="token punctuation">.</span><span class="token function">handleKeyEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">||</span> handled<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//...</span>
      <span class="token comment">// 触发[keyMessageHandler]中的事件监听回调</span>
      handled <span class="token operator">=</span> <span class="token function">_dispatchKeyMessage</span><span class="token punctuation">(</span>_keyEventsSinceLastMessage<span class="token punctuation">,</span> rawEvent<span class="token punctuation">)</span> <span class="token operator">||</span> handled<span class="token punctuation">;</span>
      _keyEventsSinceLastMessage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token keyword">dynamic</span><span class="token operator">&gt;</span><span class="token punctuation">{</span> <span class="token string">'handled'</span><span class="token punctuation">:</span> handled <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>两个事件机制处理几乎一样，<code>handled</code>表示Flutter中是否消费该键盘事件，如果Flutter没有消费，引擎接入层可以根据此判断事件消费规则。</p> <p>如果我们要在业务中全局监听某个键盘事件怎么办呢，我们可以使用<code>HardwareKeyboard</code>来做到这一点。</p> <h3 id="hardwarekeyboard"><a href="#hardwarekeyboard" aria-hidden="true" class="header-anchor">#</a> HardwareKeyboard</h3> <p>HardwareKeyboard提供了键盘事件监听以及提供事件按下列表</p> <p>属性：</p> <ul><li>physicalKeysPressed-&gt;Set<PhysicalKeyboardKey>当前已按下的物理键值</PhysicalKeyboardKey></li> <li>logicalKeysPressed-&gt;Set<LogicalKeyboardKey>: 当前已按下的逻辑键值</LogicalKeyboardKey></li> <li>lockModesEnabled-&gt;Set<KeyboardLockMode>: 当前已按下的lock键（numLock、scrollLock、capsLock）</KeyboardLockMode></li></ul> <p>方法：</p> <ul><li>addHandler(KeyEventCallback handler): 添加键盘事件监听</li> <li>removeHandler(KeyEventCallback handler): 移除键盘事件监听</li></ul> <p>如果我们想全局监听一些键盘事件且不想影响其它已有的功能，那么可以用<code>addHandler</code>方法来进行监听，比如以下例子，实现Ctrl+S保存一段信息</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">_MyWidgetState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>MyWidget<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    HardwareKeyboard<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span>_handleEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    HardwareKeyboard<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">removeHandler</span><span class="token punctuation">(</span>_handleEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  bool <span class="token function">_handleEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>HardwareKeyboard<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>logicalKeysPressed<span class="token punctuation">.</span><span class="token function">containsAll</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>LogicalKeyboardKey<span class="token punctuation">.</span>controlLeft<span class="token punctuation">,</span> LogicalKeyboardKey<span class="token punctuation">.</span>keyA<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Press Ctrl+A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>当同时按下<code>Ctrl</code>和<code>A</code>时，就会打印上面的<code>Press Ctrl+A</code>。通过<code>HardwareKeyboard</code>的<code>addHandler</code>就可以实现全局对键盘事件的监听。</p> <h3 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h3> <p>Flutter中封装处理了键盘事件。Flutter提供了两种事件传递机制，但是当前都还没有完全迁入新的机制中，所以添加了<code>KeyEventManager</code>来进行统一处理。如果我们需要全局监听键盘事件，可以通过<code>HardwareKeyboard.instance.addHandler</code>进行监听处理我们需要的键盘事件。</p> <p>但是我们的界面一般都是很复杂的，比如我们界面有很多按钮，每个按钮都能响应Enter键表示按下，那么当我们按下Enter键时到底应该哪个组件响应呢？这个时候我们就要用到Flutter中的焦点系统来管理。</p> <h2 id="焦点系统（focus）"><a href="#焦点系统（focus）" aria-hidden="true" class="header-anchor">#</a> 焦点系统（Focus）</h2> <p>Flutter提供了一系列组件用于焦点的管理，在了解此内容之前，先简单列几个<a href="https://docs.flutter.dev/ui/interactivity/focus" target="_blank" rel="noopener noreferrer">专业术语<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li>焦点树(Focus tree): 焦点像Widget树一样是一个树形结构，所有焦点组成了焦点树</li> <li>焦点节点(FocusNode): 焦点树中的节点。它上面有一些属性，比如<code>hasFocus</code>可以判断当前是否获得焦点，只有获得焦点才会响应键盘事件。</li> <li>主焦点(primaryFocus): 当前正获得焦点的焦点节点。主焦点节点全局有且只有一个。</li> <li>焦点链(Focus chain): 焦点节点的有序列表。</li> <li>焦点范围(Focus scope): 特殊的焦点节点，用于控制焦点范围。当一组焦点节点被此组件包裹时，焦点就只能在这个组件中移动</li> <li>焦点遍历(Focus traversal): 焦点从一个移动到另一个的过程。一般我们可以通过键盘的<code>Tab</code>进行切换焦点。</li></ul> <h3 id="focus"><a href="#focus" aria-hidden="true" class="header-anchor">#</a> Focus</h3> <p>Focus组件是Flutter提供的专用于控制组件焦点组件，我们只需要简单的将自定义的组件使用<code>Focus</code>包起来，就能让我们组件拥有焦点并做一些特定的事情。</p> <p>Focus提供重要入参如下</p> <ul><li>child：子组件</li> <li>focusNode: 焦点节点</li> <li>parentNode: 父焦点节点</li> <li>autofocus: 如果为true，当前节点会默认获取焦点</li> <li>onFocusChange: 焦点变化时回调</li> <li>onKeyEvent: 键盘事件回调</li> <li>onKey: 同上，建议业务中都使用onKeyEvent，如果用新的键盘事件接入，onKey将不会收到事件回调。</li> <li>canRequestFocus: 是否支持获取焦点。如果是true，当前节点不会获取焦点，也不能使用<code>requestFocus</code>来获取焦点，不过当子节点获取焦点时，它的<code>hasFocus</code>依然返回true</li> <li>skipTraversal: 无法通过遍历获取焦点（比如通过按<code>Tab</code>键）。与<code>canRequestFocus</code>的区别是此属性仅影响<code>FocusTraversalPolicy</code>遍历的方式来获取焦点，我们还是可以通过<code>requestFocus</code>来获取焦点。</li> <li>descendantsAreFocusable: 默认为true，如果为false，可以使该组件的后代节点无法获得焦点（与<code>canRequestFocus</code>对应，只是影响对象不一样）。</li> <li>descendantsAreTraversable: 默认为true，如果为false，可以使该组件的后代节点无法被遍历（与<code>skipTraversal</code>对应，会影响<code>skipTraversal</code>的结果）</li> <li>includeSemantics: 默认为true，会在组件中包<code>Semantics</code></li></ul> <p><code>Focus</code>组件主要是做以下几件事</p> <ol><li>将<code>focusNode</code>与Focus组件关联起来</li> <li>嵌套<code>_FocusInheritedScope</code>，然后可以通过<code>Focus.maybeOf</code>来获取当前组件父组件上最近的<code>FocusNode</code>节点</li></ol> <p><code>Focus</code>组件和<code>FocusNode</code>共同组成了一个焦点节点，其中focusNode可以从外面传入，也可以<code>Focus</code>组件内部生成。</p> <p>下面再简单介绍一下<code>FocusNode</code></p> <h3 id="focusnode"><a href="#focusnode" aria-hidden="true" class="header-anchor">#</a> FocusNode</h3> <p><code>FocusNode</code>组件也提供了<code>onKey</code>、<code>onKeyEvent</code>、<code>skipTraversal</code>、<code>canRequestFocus</code>、<code>descendantsAreFocusable</code>、<code>descendantsAreTraversable</code>入参，效果同上面一致，但是如果<code>Focus</code>组件上设置过，<code>Focus</code>组件上的优先级更高。</p> <p>它还提供了一些有用的属性</p> <ul><li>canRequestFocus: 当前组件是否能获得焦点。它会依次判断当前组件的<code>_canRequestFocus</code>，父组件的<code>canRequestFocus</code>，以及祖先节点的<code>descendantsAreFocusable</code>。</li> <li>parent: 父焦点节点。记录的是焦点链的父节点，不是Widget组件的父节点，返回的是<code>FocusNode</code></li> <li>children: 当前节点的子焦点节点。同上，返回的是<code>Iterable&lt;FocusNode&gt;</code>。</li> <li>traversalChildren: 当前节点的<code>可遍历</code>的子焦点节点。根据<code>descendantsAreFocusable</code>、<code>canRequestFocus</code>、<code>skipTraversal</code>综合判断获取的结果。</li> <li>descendants: 当前节点的所有后代焦点节点。</li> <li>traversalDescendants: 当前节点的所有<code>可遍历</code>的后代焦点节点。</li> <li>ancestors: 祖先节点们。</li> <li>hasFocus: 是否获得焦点，当祖先节点获得焦点，此属性也返回true。</li> <li>hasPrimaryFocus: 当前节点是否获得焦点。与<code>hasFocus</code>不同的是此属性会与<code>primaryFocus</code>全匹配。</li> <li>nearestScope: 通过查找祖先节点，找到最近的<code>FocusScopeNode</code>，包含自己。因为本身肯定不是<code>FocusScopeNode</code>， 所以默认指向<code>enclosingScope</code>。</li> <li>enclosingScope: 通过查找祖先节点，找到最近的<code>FocusScopeNode</code>，不包含自己。</li> <li>size: 与此<code>FocusNode</code>绑定的<code>Focus</code>组件的宽高。</li> <li>offset: 与此<code>FocusNode</code>绑定的<code>Focus</code>组件的位置。位置经过变换，拿到的是组件相对于全局窗口的位置。</li></ul> <p>同样也提供了一些方法：</p> <ul><li>unfocus: 移除当前节点的焦点，将焦点移动到下一个节点或者上一个节点。</li> <li>consumeKeyboardToken: 当节点获得焦点时会获得一个令牌，可以通过此函数来判断是否存在令牌，并消耗令牌。主要用于移动端拉起键盘。</li> <li>reparent：将此节点添加到传入的<code>parent</code>节点的<code>children</code>中。</li> <li>attach: Widget与此FocusNode建立连接。<code>Focus</code>组件也是通过此函数与<code>FocusNode</code>建立的一对一的关系。</li> <li>dispose: Widget与此FocusNode断开连接时调用。</li> <li>requestFocus([FocusNode? node]): 请求为当前节点或者传入的<code>node</code>节点获取焦点。</li> <li>nextFocus: 焦点向下一个节点移动。</li> <li>previousFocus: 焦点向上一个节点移动。</li> <li>focusInDirection: 通过方向控制焦点的移动。</li></ul> <p>当然<code>FocusNode</code>本身使用了<code>ChangeNotifier</code>，我们可以通过<code>focusNode.addListener</code>来监听当前节点的焦点变化。</p> <h3 id="focusscope-focusscopenode"><a href="#focusscope-focusscopenode" aria-hidden="true" class="header-anchor">#</a> FocusScope &amp; FocusScopeNode</h3> <p><code>FocusScopeNode</code>是一种特殊的<code>FocusNode</code>，它将<code>FocusNode</code>组成更小的范围。比如下图的例子</p> <p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/focusScope.gif" alt=""></p> <p>当前面三个输入框被FocusScope包裹后，它们就组成了一个内部的焦点范围，此时按Tab键只能在这三个输入框中切换焦点，当我手动将焦点移动到4输入框后，此时焦点会在外面的焦点范围切换，从<code>TextButton</code>重新切换到<code>FcousScope</code>范围后，上次离开的焦点会再次获得焦点。</p> <ul><li>traversalEdgeBehavior: 用于控制子节点到达最后一个节点后焦点的移动规则。
<ul><li><code>TraversalEdgeBehavior.closedLoop</code>表示循环移动，达到最后一个后又从第一个开始</li> <li><code>TraversalEdgeBehavior.leaveFlutterView</code>表示当达到最后一个后脱离当前FlutterView。</li></ul></li> <li>focusedChild: 获取当前节点希望获得主焦点的节点。<code>FocusScope</code>中会缓存一个焦点移动的列表（_focusedChildren），<code>focusChild</code>总是取这个列表的最后一个节点。</li></ul> <p>方法：</p> <ul><li>setFirstFocus(FocusScopeNode scope): 将<code>scope</code>设置为当前范围内的子焦点，同时让<code>scope</code>获得焦点。</li> <li>autofocus(FocusNode node): 将<code>node</code>设置为自动获得焦点。</li></ul> <h3 id="focusmanager"><a href="#focusmanager" aria-hidden="true" class="header-anchor">#</a> FocusManager</h3> <p>管理焦点(FocusNode)的类。<code>FocusManager</code>由<code>BuildOwner</code>持有并可以通过<code>WidgetsBinding.instance.focusManager</code>访问。它通过持有根<code>FocusScopeNode</code>以及管理<code>primaryFocus</code>来管理主焦点。下面我们详细介绍它的属性以及方法。</p> <p>属性：</p> <ul><li>instance: 指向<code>WidgetsBinding.instance.focusManager</code>，所以也可以通过<code>FocusManager.instance</code>来获取全局<code>FocusManager</code></li> <li>highlightStrategy: 设置当前的焦点交互方式，决定<code>highlightMode</code>的返回。</li> <li>highlightMode: 决定当前焦点的交互方案。部分组件如<code>Switch</code>、<code>DatePicker</code>、<code>Slider</code>等只会在<code>FocusHighlightMode.traditional</code>下才会显示带焦点的高亮，<code>FocusHighlightMode.touch</code>则不会显示。</li> <li>rootScope: 所有<code>FocusNode</code>节点的根节点。</li> <li>primaryFocus: 当前获得焦点的节点。</li></ul> <p>方法：</p> <ul><li>registerGlobalHandlers: 注册键盘事件监听，在<code>BuildOwner</code>创建的时候调用。</li> <li>addHighlightModeListener: 添加<code>highlightMode</code>变化回调。</li> <li>removeHighlightModeListener: 移除<code>highlightMode</code>变化回调。</li> <li>_markNextFocus(FocusNode node): 由<code>FocusNode</code>调用，将<code>node</code>设置为焦点。</li></ul> <p>跟<code>FocusNode</code>一样，<code>FocusManager</code>也使用了<code>ChangeNotifier</code>，所以我们可以通过使用<code>FocusManager.instance.addListener</code>来全局监听焦点的变化。</p> <h3 id="focustraversalgroup-focustraversalpolicy"><a href="#focustraversalgroup-focustraversalpolicy" aria-hidden="true" class="header-anchor">#</a> FocusTraversalGroup &amp; FocusTraversalPolicy</h3> <p>决定当前焦点链的遍历方式的类，可以通过实现<code>sortDescendants</code>来改变焦点链的顺序从而改变焦点移动的顺序。</p> <p><code>FocusTraversalGroup</code>是一个Flutter Widget，其构造函数入参有</p> <ul><li>policy: 决定焦点从一个节点到另一个节点的规则。默认采用<code>ReadingOrderTraversalPolicy</code>，将按照阅读习惯，从左往右，从上到下。</li> <li>descendantsAreFocusable: 同上<code>Focus</code></li> <li>descendantsAreTraversable: 同上<code>Focus</code></li> <li>child: 子组件节点
此组件主要承载<code>policy</code></li></ul> <p><code>FocusTraversalPolicy</code>就是决定焦点从一个节点到另一个节点的规则。其有以下方法</p> <ul><li>findFirstFocus(FocusNode currentNode, {bool ignoreCurrentFocus = false}): 根据<code>currentNode</code>返回当前焦点链中第一个节点</li> <li>findLastFocus: 用于返回当前焦点链中最后一个节点</li> <li>findFirstFocusInDirection: 通过传入的<code>direction</code>找到焦点链中的第一个节点</li> <li>invalidateScopeData(FocusScopeNode node): 用于清除<code>node</code></li> <li>changedScope({FocusNode? node, FocusSCopeNode? oldScope}): 将焦点node从oldScope更换到当前scope</li> <li>next(FocusNode currentNode): 将焦点移动到下一个节点</li> <li>previous(FocusNode currentNode): 将焦点移动到上一个节点</li> <li>inDirection(FocusNode currentNode, TraversalDirection direction): 通过传入的<code>direction</code>找到下一个焦点节点，找到了返回true否则返回false</li> <li>sortDescendants: 调整焦点节点的排序规则</li></ul> <p>简单说<code>FocusTraversalPolicy</code>是焦点系统中确认焦点遍历策略的类，我们可以通过实现它来完成焦点遍历规则的指定，Flutter自己也实现了多个规则，如下</p> <ul><li>WidgetOrderTraversalPolicy: 依赖焦点节点在Widget中的构建顺序来定义焦点顺序。</li> <li>ReadingOrderTraversalPolicy: 它按照阅读（文本）的自然顺序来确定焦点的移动。这个顺序通常取决于使用的语言（例如，从左到右或从右到左，对于从上到下的方向也是如此）。</li> <li>OrderedTraversalPolicy: 这个重点说一下，Flutter中本身并没有使用该类的地方，它提供了一个更加灵活的遍历方式，我们可以通过自定义比较函数来定义焦点节点的遍历顺序。以下有个例子</li></ul> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:flutter/material.dart'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">DemoButton</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">DemoButton</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    Key<span class="token operator">?</span> key<span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>autofocus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    required <span class="token keyword">this</span><span class="token punctuation">.</span>order<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> String name<span class="token punctuation">;</span>
  <span class="token keyword">final</span> bool autofocus<span class="token punctuation">;</span>
  <span class="token keyword">final</span> double order<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">_handleOnPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'Button $name pressed.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debugDumpFocusTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">FocusTraversalOrder</span><span class="token punctuation">(</span>
      order<span class="token punctuation">:</span> <span class="token function">NumericFocusOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token function">TextButton</span><span class="token punctuation">(</span>
        autofocus<span class="token punctuation">:</span> autofocus<span class="token punctuation">,</span>
        onPressed<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleOnPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">OrderedTraversalPolicyExample</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">OrderedTraversalPolicyExample</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Key<span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">FocusTraversalGroup</span><span class="token punctuation">(</span>
      policy<span class="token punctuation">:</span> <span class="token function">OrderedTraversalPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token function">Column</span><span class="token punctuation">(</span>
        mainAxisAlignment<span class="token punctuation">:</span> MainAxisAlignment<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
          <span class="token function">Row</span><span class="token punctuation">(</span>
            mainAxisAlignment<span class="token punctuation">:</span> MainAxisAlignment<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
            children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
              <span class="token function">DemoButton</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'Six'</span><span class="token punctuation">,</span> order<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">Row</span><span class="token punctuation">(</span>
            mainAxisAlignment<span class="token punctuation">:</span> MainAxisAlignment<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
            children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
              <span class="token function">DemoButton</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'Five'</span><span class="token punctuation">,</span> order<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">DemoButton</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'Four'</span><span class="token punctuation">,</span> order<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">Row</span><span class="token punctuation">(</span>
            mainAxisAlignment<span class="token punctuation">:</span> MainAxisAlignment<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
            children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
              <span class="token function">DemoButton</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'Three'</span><span class="token punctuation">,</span> order<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">DemoButton</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'Two'</span><span class="token punctuation">,</span> order<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">DemoButton</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">'One'</span><span class="token punctuation">,</span> order<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> autofocus<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>通过父组件使用<code>FocusTraversalGroup</code>，子组件使用<code>FocusTraversalOrder</code>配合<code>NumericFocusOrder</code>，我们就能实现自定义的焦点移动。上面代码执行后如下</p> <p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/FocusTraversalOrder.gif" alt=""></p> <p>通过点按<code>Tab</code>键，焦点会从地下的<code>One</code>开始向上移动。</p> <h3 id="其它关键类"><a href="#其它关键类" aria-hidden="true" class="header-anchor">#</a> 其它关键类</h3> <ul><li>FocusAttachment: 用于FocusNode与Widget建立绑定关系的类。</li> <li>FocusableActionDetector: 用于检测焦点情况，控制UI样式</li></ul> <h3 id="完整链路梳理"><a href="#完整链路梳理" aria-hidden="true" class="header-anchor">#</a> 完整链路梳理</h3> <h4 id="初始化"><a href="#初始化" aria-hidden="true" class="header-anchor">#</a> 初始化</h4> <p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/foucs.png" alt="Focus初始化"></p> <p>当Flutter启动时，<code>BuildOwner</code>组件会初始化<code>FocusManager</code>,<code>FocusManager</code>创建时会初始化<code>rootScope</code>，<code>rootScope</code>会作为焦点链的根节点。在<code>Navigator</code>和<code>Route</code>组件中，都有使用<code>FcousScope</code>，其中<code>Route</code>中会初始化一个<code>FocusScopeNode</code>，通过调用<code>setFirstFocus</code>与父<code>FocusScopeNode</code>建立联系，然后<code>TextField</code>、<code>Switch</code>、<code>TextButton</code>组件通过使用<code>Focus</code>组件的方式绑定了<code>FocusNode</code>，它们通过调用<code>reparent</code>的方式与父FocusScopeNode建立绑定。</p> <h4 id="焦点遍历"><a href="#焦点遍历" aria-hidden="true" class="header-anchor">#</a> 焦点遍历</h4> <p>为了更好的体验，焦点是可以通过自动往下一个焦点移动，比如移动端的键盘上的<code>下一个</code>，或者在桌面端上按<code>Tab</code>键。下面是按下<code>Tab</code>键键盘的移动流程。</p> <h5 id="顺序移动焦点"><a href="#顺序移动焦点" aria-hidden="true" class="header-anchor">#</a> 顺序移动焦点</h5> <p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/focus_move.png" alt="">
当按下<code>Tab</code>键时，会触发<code>NextFocusAction.invoke</code>（后续再讲这块），<code>invoke</code>中通过调用当前焦点节点的<code>nextFocus</code>进行焦点移动，<code>FocusNode</code>中会调用<code>FocusTraversalPolicy</code>的<code>next</code>函数，通过<code>FocusTraversalPolicy</code>的策略拿到下一个节点，下一个节点会调用自身的<code>requestFocus</code>，最后通过调用<code>FocusManager</code>的<code>_markNextFocus</code>将自身设置为主焦点，最后触发监听界面响应。</p> <h5 id="反向移动焦点"><a href="#反向移动焦点" aria-hidden="true" class="header-anchor">#</a> 反向移动焦点</h5> <p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/focus_move_previous.png" alt="">
上图大部分流程上跟顺序移动流程一致，只有黄色部分不一致。最大不一样是<code>_moveFocus</code>中会从焦点链中反向找到焦点节点，然后调用该节点的<code>requestFocus</code>。</p> <h4 id="方向键移动焦点"><a href="#方向键移动焦点" aria-hidden="true" class="header-anchor">#</a> 方向键移动焦点</h4> <p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/focus_move_direction.png" alt="">
除了使用<code>Tab</code>以及<code>Tab + Shift</code>进行焦点移动外，还支持使用方向键进行焦点移动，在这个场景下，一般焦点移动的规则是依赖布局位置，Flutter提供了<code>DirectionalFocusTraversalPolicyMixin</code>这个mixin来处理方向的焦点移动，它通过实现<code>inDirection</code>，通过焦点节点提供的<code>rect</code>属性进行位置比较获取更合适的位置，然后将该焦点设置为主焦点。</p> <h4 id="触发键盘事件"><a href="#触发键盘事件" aria-hidden="true" class="header-anchor">#</a> 触发键盘事件</h4> <p>接上面<code>KeyEventManager</code>部分，<code>FocusManager</code>初始化时会调用<code>ServicesBinding.instance.keyEventManager.keyMessageHandler = handleKeyMessage</code>绑定事件。</p> <p><code>handleKeyMessage</code>中的处理：</p> <blockquote><p>packages/flutter/lib/src/widgets/focus_manager.dart</p></blockquote> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>bool <span class="token function">handleKeyMessage</span><span class="token punctuation">(</span>KeyMessage message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    bool handled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 主焦点节点以及该节点的祖先节点都会响应事件</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> FocusNode node <span class="token keyword">in</span> <span class="token operator">&lt;</span>FocusNode<span class="token operator">&gt;</span><span class="token punctuation">[</span>
      FocusManager<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>primaryFocus<span class="token operator">!</span><span class="token punctuation">,</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>FocusManager<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>primaryFocus<span class="token operator">!</span><span class="token punctuation">.</span>ancestors<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> List<span class="token operator">&lt;</span>KeyEventResult<span class="token operator">&gt;</span> results <span class="token operator">=</span> <span class="token operator">&lt;</span>KeyEventResult<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 调用onKeyEvent，触发事件回调</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>onKeyEvent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> KeyEvent event <span class="token keyword">in</span> message<span class="token punctuation">.</span>events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>onKeyEvent<span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 调用onKey，触发事件回调</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>onKey <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> message<span class="token punctuation">.</span>rawEvent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>onKey<span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> message<span class="token punctuation">.</span>rawEvent<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">final</span> KeyEventResult result <span class="token operator">=</span> <span class="token function">combineKeyEventResults</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 处理事件向上传递规则</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> KeyEventResult<span class="token punctuation">.</span>ignored<span class="token punctuation">:</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KeyEventResult<span class="token punctuation">.</span>handled<span class="token punctuation">:</span>
          handled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KeyEventResult<span class="token punctuation">.</span>skipRemainingHandlers<span class="token punctuation">:</span>
          handled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token function">_focusDebug</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Key event not handled by anyone: $message.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> handled<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>通过循环主焦点节点以及它的祖先节点，依次触发事件响应。根据返回的<code>KeyEventResult</code>可以决定事件传递规则</p> <ul><li>ignored：忽略当前节点，事件继续向祖先<code>Focus</code>节点传递</li> <li>handled：事件被处理，终止事件向上传递并向引擎返回事件被处理标记</li> <li>skipRemainingHandlers：事件被处理，终止事件向上传递但向引擎返回事件未被处理标记，让引擎处理后续事件</li></ul> <h3 id="小结-2"><a href="#小结-2" aria-hidden="true" class="header-anchor">#</a> 小结</h3> <ul><li>焦点系统方便我们把某些事件聚焦到某个组件上而不是全局响应</li> <li>焦点节点是一个树，但是主焦点有且只有一个，所以事件响应可以从主焦点沿着树往上向根节点冒泡，直到事件被接受处理（返回<code>KeyEventResult.handled</code>）</li> <li>焦点系统有自己的移动规则，我们也可以根据软件特性自定义移动规则</li> <li>在焦点不知道去哪的时候，Flutter提供了一些有用的焦点调试方法，如可以通过设置<code>debugFocusChanges = true</code>来输出更多有用的焦点日志，也可以使用<code>debugDumpFocusTree</code>或<code>debugDescribeFocusTree</code>来打印当前焦点树的信息。</li></ul> <h2 id="快捷键（shortcuts）"><a href="#快捷键（shortcuts）" aria-hidden="true" class="header-anchor">#</a> 快捷键（Shortcuts）</h2> <p>焦点系统只能监听原始事件并处理，如果我要定义多个快捷键要处理起来是很不友好，所以Flutter提供了快捷键相关的组件来方便我们定义自己的快捷键。</p> <h3 id="callbackshortcuts"><a href="#callbackshortcuts" aria-hidden="true" class="header-anchor">#</a> CallbackShortcuts</h3> <p><code>CallbackShortcuts</code>是一个Widget组件，我们可以添加一个<code>binding</code>来定义键盘事件的响应，如</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token metadata symbol">@override</span>
Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">CallbackShortcuts</span><span class="token punctuation">(</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&lt;</span>ShortcutActivator<span class="token punctuation">,</span> VoidCallback<span class="token operator">&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function">SingleActivator</span><span class="token punctuation">(</span>LogicalKeyboardKey<span class="token punctuation">.</span>arrowUp<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">const</span> <span class="token function">SingleActivator</span><span class="token punctuation">(</span>LogicalKeyboardKey<span class="token punctuation">.</span>arrowDown<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> count <span class="token operator">=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    child<span class="token punctuation">:</span> <span class="token function">Focus</span><span class="token punctuation">(</span>
      autofocus<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token function">Column</span><span class="token punctuation">(</span>
        children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
          <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">'count: $count'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>上面代码组件会自动获得焦点，<code>CallbackShortcuts</code>的binding上绑定了两个快捷键事件，<code>LogicalKeyboardKey.arrowUp</code>是方向键上，点击后<code>count</code>会加1，<code>LogicalKeyboardKey.arrowDown</code>是方向键下，点击后<code>count</code>会减1。<code>bindings</code>是一个Map类型，键是<code>ShortcutActivator</code>用来定义一组快捷键，值是空函数。</p> <h3 id="shortcutactivator"><a href="#shortcutactivator" aria-hidden="true" class="header-anchor">#</a> ShortcutActivator</h3> <p>一般快捷键都是多个键组合的，比如我们常用的复制(Ctrl + C)、粘贴（Ctrl + V）、全选（Ctrl + A）等，<code>ShortcutActivator</code>就是将这些快捷键键组合起来的类，它本身是一个接口类，有以下定义</p> <p>Iterable<LogicalKeyboardKey>? get triggers: 按键组合列表
bool accepts(RawKeyEvent event, RawKeyboard state): 是否接受事件。一般快捷方式是更复杂的，比如复制（Ctrl + C），需要判断C按下的情况下有且仅有Ctrl也是按下状态才会响应。</LogicalKeyboardKey></p> <p>Flutter提供了几种方便的<code>ShortcutActivator</code></p> <ul><li>LogicalKeySet: 支持传入一组<code>LogicalKeyboardKey</code>，有且仅有这些键按下时会响应</li> <li>SingleActivator: 仅支持传入一个<code>LogicalKeyboardKey</code>，但支持设置常用功能键<code>control</code>、<code>shift</code>、<code>alt</code>、<code>meta</code>是否按下</li> <li>CharacterActivator: 类似<code>SingleActivator</code>，区别是传入是是一个按键的字符串<code>character</code>，该<code>character</code>和<code>RawKeyEvent</code>下的<code>character</code>进行匹配。</li></ul> <h3 id="shortcuts-actions"><a href="#shortcuts-actions" aria-hidden="true" class="header-anchor">#</a> Shortcuts &amp; Actions</h3> <p>对于简单的快捷键操作上面的<code>ShortcutActivator</code>就已经很好用了，对于更复杂界面及业务场景，快捷键的意图与操作分离也是必要的。比如我们知道<code>Ctrl + C</code>是复制，但是在不同组件复制的内容是不一样的，在输入框中复制的输入框里所有文字，下拉框中复制的是当前选中的内容，日期选择中复制的是当前选择的日志格式化形式。为了应对这种场景，Flutter提供了两个组件<code>Shortcuts</code>和<code>Actions</code>，<code>Shortcuts</code>用来定义快捷键的意图；<code>Actions</code>用来定义快捷键的具体操作。</p> <p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/using_shortcuts.png" alt="https://docs.flutter.dev/ui/interactivity/actions-and-shortcuts"></p> <blockquote><p>图片来自https://docs.flutter.dev/ui/interactivity/actions-and-shortcuts</p></blockquote> <p>从工作原理来说，分为两个过程，首先<code>Shortcuts</code>中根据从主焦点节点沿着焦点链向上找到最近的<code>Intent</code>（依赖Focus能力），然后根据<code>Intent</code>找到最近的<code>Action</code>最后执行<code>Action</code>上的<code>invoke</code>方法。通过这两个过程完成键盘绑定与操作的解耦。我们可以定义通用的快捷键，子组件自行实现Action，也可以定义通用的Action，子组件中绑定不同的快捷键。</p> <p>下面用一个通过改写上面<code>CallbackShortcuts</code>的简单示例看看<code>Shortcuts</code>和<code>Actions</code>如何工作的</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">ShortcutsExampleApp</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">ShortcutsExampleApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword">super</span><span class="token punctuation">.</span>key<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">MaterialApp</span><span class="token punctuation">(</span>
      home<span class="token punctuation">:</span> <span class="token function">Scaffold</span><span class="token punctuation">(</span>
        appBar<span class="token punctuation">:</span> <span class="token function">AppBar</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">'Shortcuts Sample'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token function">Center</span><span class="token punctuation">(</span>
          child<span class="token punctuation">:</span> <span class="token function">ShortcutsExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Model</span> <span class="token keyword">with</span> ChangeNotifier <span class="token punctuation">{</span>
  int count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">incrementBy</span><span class="token punctuation">(</span>int amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    count <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
    <span class="token function">notifyListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">decrementBy</span><span class="token punctuation">(</span>int amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    count <span class="token operator">-=</span> amount<span class="token punctuation">;</span>
    <span class="token function">notifyListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">IncrementIntent</span> <span class="token keyword">extends</span> <span class="token class-name">Intent</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">IncrementIntent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> int amount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DecrementIntent</span> <span class="token keyword">extends</span> <span class="token class-name">Intent</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">DecrementIntent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> int amount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">IncrementAction</span> <span class="token keyword">extends</span> <span class="token class-name">Action</span><span class="token operator">&lt;</span>IncrementIntent<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">IncrementAction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> Model model<span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span>covariant IncrementIntent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">.</span><span class="token function">incrementBy</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DecrementAction</span> <span class="token keyword">extends</span> <span class="token class-name">Action</span><span class="token operator">&lt;</span>DecrementIntent<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">DecrementAction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> Model model<span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span>covariant DecrementIntent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">.</span><span class="token function">decrementBy</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ShortcutsExample</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">ShortcutsExample</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword">super</span><span class="token punctuation">.</span>key<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  State<span class="token operator">&lt;</span>ShortcutsExample<span class="token operator">&gt;</span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_ShortcutsExampleState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">_ShortcutsExampleState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>ShortcutsExample<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  Model model <span class="token operator">=</span> <span class="token function">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Shortcuts</span><span class="token punctuation">(</span>
      shortcuts<span class="token punctuation">:</span> <span class="token operator">&lt;</span>ShortcutActivator<span class="token punctuation">,</span> Intent<span class="token operator">&gt;</span><span class="token punctuation">{</span>
        <span class="token function">LogicalKeySet</span><span class="token punctuation">(</span>LogicalKeyboardKey<span class="token punctuation">.</span>arrowUp<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token function">IncrementIntent</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">LogicalKeySet</span><span class="token punctuation">(</span>LogicalKeyboardKey<span class="token punctuation">.</span>arrowDown<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token function">DecrementIntent</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token function">Actions</span><span class="token punctuation">(</span>
        actions<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Type<span class="token punctuation">,</span> Action<span class="token operator">&lt;</span>Intent<span class="token operator">&gt;&gt;</span><span class="token punctuation">{</span>
          IncrementIntent<span class="token punctuation">:</span> <span class="token function">IncrementAction</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span>
          DecrementIntent<span class="token punctuation">:</span> <span class="token function">DecrementAction</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token function">Focus</span><span class="token punctuation">(</span>
          autofocus<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          child<span class="token punctuation">:</span> <span class="token function">Column</span><span class="token punctuation">(</span>
            children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
              <span class="token function">AnimatedBuilder</span><span class="token punctuation">(</span>
                animation<span class="token punctuation">:</span> model<span class="token punctuation">,</span>
                builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>BuildContext context<span class="token punctuation">,</span> Widget<span class="token operator">?</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">'count: ${model.count}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br></div></div><p>此示例跟上面一样，通过键盘的上下键控制数字的增减。<code>Shortcuts</code>和<code>Actions</code>都接受一个map，它们通过<code>Intent</code>进行获得联系，当键盘上触发时，首先根据<code>Shortcuts</code>组件找到绑定的<code>IncrementIntent</code>，然后根据<code>Intent</code>找到<code>IncrementAction</code>并执行Action。</p> <p>下面通过源码分析一下<code>Shortcuts</code>及<code>Actions</code>工作原理。</p> <h3 id="shortcuts"><a href="#shortcuts" aria-hidden="true" class="header-anchor">#</a> Shortcuts</h3> <p>我们看看<code>Shortcuts</code>部分代码</p> <blockquote><p>packages/flutter/lib/src/widgets/shortcuts.dart</p></blockquote> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">_ShortcutsState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>Shortcuts<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// ...</span>
KeyEventResult <span class="token function">_handleOnKey</span><span class="token punctuation">(</span>FocusNode node<span class="token punctuation">,</span> RawKeyEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> KeyEventResult<span class="token punctuation">.</span>ignored<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> manager<span class="token punctuation">.</span><span class="token function">handleKeypress</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>context<span class="token operator">!</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Focus</span><span class="token punctuation">(</span>
      debugLabel<span class="token punctuation">:</span> <span class="token string">'$Shortcuts'</span><span class="token punctuation">,</span>
      canRequestFocus<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      onKey<span class="token punctuation">:</span> _handleOnKey<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> widget<span class="token punctuation">.</span>child<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>从这里可以看出<code>Shortcuts</code>仅仅是使用了<code>Focus</code>组件，它俩在实现上的是没有耦合的。<code>Shortcuts</code>很简单，它使用<code>Focus</code>键盘事件，并持有一个<code>ShortcutManager</code>，当<code>Focus</code>的事件触发后，执行<code>ShortcutManager</code>的<code>handleKeypress</code>。</p> <p>在<code>ShortcutManager</code>中的执行如下</p> <blockquote><p>packages/flutter/lib/src/widgets/shortcuts.dart</p></blockquote> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">//...</span>
KeyEventResult <span class="token function">handleKeypress</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">,</span> RawKeyEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过持有的shortcuts以及event找到匹配的Intent</span>
    <span class="token keyword">final</span> Intent<span class="token operator">?</span> matchedIntent <span class="token operator">=</span> <span class="token function">_find</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> RawKeyboard<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matchedIntent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> BuildContext<span class="token operator">?</span> primaryContext <span class="token operator">=</span> primaryFocus<span class="token operator">?</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>primaryContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从主焦点开始向上寻找，找到第一个匹配的Action就返回</span>
        <span class="token keyword">final</span> Action<span class="token operator">&lt;</span>Intent<span class="token operator">&gt;</span><span class="token operator">?</span> action <span class="token operator">=</span> Actions<span class="token punctuation">.</span>maybeFind<span class="token operator">&lt;</span>Intent<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          primaryContext<span class="token punctuation">,</span>
          intent<span class="token punctuation">:</span> matchedIntent<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> action<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span>matchedIntent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 触发action响应</span>
          <span class="token keyword">final</span> Object<span class="token operator">?</span> invokeResult <span class="token operator">=</span> Actions<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>primaryContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invokeAction</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> matchedIntent<span class="token punctuation">,</span> primaryContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> action<span class="token punctuation">.</span><span class="token function">toKeyEventResult</span><span class="token punctuation">(</span>matchedIntent<span class="token punctuation">,</span> invokeResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> modal <span class="token operator">?</span> KeyEventResult<span class="token punctuation">.</span>skipRemainingHandlers <span class="token punctuation">:</span> KeyEventResult<span class="token punctuation">.</span>ignored<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>触发Action分为几步，首先会先通过<code>event</code>找到匹配的意图<code>Intent</code>，然后通过当前组件（也就是<code>Shortcuts</code>）的<code>context</code>向上查找，找到最近的<code>Action</code>，然后触发执行<code>Action</code>的<code>invoke</code>以及<code>toKeyEventResult</code>。</p> <p><code>Actions.of</code>返回的是<code>ActionDispatcher</code>，它负责Action的<code>invoke</code>的执行。</p> <h3 id="actions"><a href="#actions" aria-hidden="true" class="header-anchor">#</a> Actions</h3> <p>上面触发Actions的过程中使用了多个Actions的方法，实际上，<code>Actions</code>还提供了更丰富的方法。</p> <h4 id="find-maybefind"><a href="#find-maybefind" aria-hidden="true" class="header-anchor">#</a> find &amp; maybeFind</h4> <p>根据<code>Intent</code>找到最近的Action。<code>find</code>与<code>maybeFind</code>区别是find没找到会报错，<code>maybeFind</code>没找到会返回null。</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>Action<span class="token operator">&lt;</span>SelectAllIntent<span class="token operator">&gt;</span> selectAllAction <span class="token operator">=</span> Actions<span class="token punctuation">.</span>find<span class="token operator">&lt;</span>SelectAllIntent<span class="token operator">&gt;</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
Action<span class="token operator">&lt;</span>SelectAllIntent<span class="token operator">&gt;</span><span class="token operator">?</span> selectAll <span class="token operator">=</span> Actions<span class="token punctuation">.</span>maybeFind<span class="token operator">&lt;</span>SelectAllIntent<span class="token operator">&gt;</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="invoke-maybeinvoek"><a href="#invoke-maybeinvoek" aria-hidden="true" class="header-anchor">#</a> invoke &amp; maybeInvoek</h4> <p>通过context及Intent找到最近的Action并执行。区别是<code>invoke</code>没找到对应的Action会报错，<code>maybeInvoek</code>不会。</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token function">TextButton</span><span class="token punctuation">(</span>
  onPressed<span class="token punctuation">:</span> Actions<span class="token punctuation">.</span>maybeFind<span class="token operator">&lt;</span>SelectAllIntent<span class="token operator">&gt;</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Actions<span class="token punctuation">.</span>invoke<span class="token operator">&lt;</span>SelectAllIntent<span class="token operator">&gt;</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token function">SelectAllIntent</span><span class="token punctuation">(</span>controller<span class="token punctuation">:</span> controller<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  child<span class="token punctuation">:</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">'SelectAll'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="handler"><a href="#handler" aria-hidden="true" class="header-anchor">#</a> handler</h4> <p>如果要根据<code>Intent</code>及<code>context</code>先找到当前组件最近的Action，先返回一个空函数，没找到会返回null，再次执行函数会触发Action的执行。可以配合在某些操作上，比如点击后触发<code>SelectAll</code>的<code>Action</code>。</p> <p>上面的例子通过<code>handler</code>改写会简单很多</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token function">TextButton</span><span class="token punctuation">(</span>
  onPressed<span class="token punctuation">:</span> Actions<span class="token punctuation">.</span>handler<span class="token operator">&lt;</span>SelectAllIntent<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    context<span class="token punctuation">,</span>
    <span class="token function">SelectAllIntent</span><span class="token punctuation">(</span>controller<span class="token punctuation">:</span> controller<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string">'SELECT ALL'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="已有的-intent-action"><a href="#已有的-intent-action" aria-hidden="true" class="header-anchor">#</a> 已有的 Intent &amp; Action</h3> <p><code>Intent</code>本身几乎没什么含义，但Flutte也定义了很多有多种含义的<code>Intent</code>及<code>Action</code></p> <ul><li>ContextAction: invoke执行时会带context的特殊Action</li> <li>CallbackAction: 可以直接通过传入<code>onInvke</code>回调的Action</li> <li>VoidCallbackIntent &amp; VoidCallbackAction: 直接通过<code>VoidCallbackAction(() { })</code>当成Action传入。类似<code>CallbackAction</code>，不同的是回调中不会带Intent参数。</li> <li>DoNotingIntent &amp; DoNothingAction: 不做任何事情的Action，可以用于阻止Action向上传递</li> <li>ActivateIntent &amp; ActivateAction: 激活组件。默认会被绑定到<code>空格键</code>，在除了Web端上还会绑定到<code>Enter键</code>。</li> <li>ButtonActivateIntent: 在Web端上被绑定到<code>Enter</code>键上。</li> <li>SelectIntent &amp; SelectAction: 选择组件。</li> <li>DismissIntent &amp; DismissAction: 退出，绑定在ESC键上。</li> <li>PrioritizedIntents &amp; PrioritizedAction: 可以传入多个<code>Intent</code>并按顺序执行直到有<code>Action</code>响应。可以方便组合多个Intent。</li></ul> <h3 id="示例"><a href="#示例" aria-hidden="true" class="header-anchor">#</a> 示例</h3> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">ShortcutsAndAction</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">ShortcutsAndAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Key<span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  State<span class="token operator">&lt;</span>ShortcutsAndAction<span class="token operator">&gt;</span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_ShortcutsAndActionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">_ShortcutsAndActionState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>ShortcutsAndAction<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Scaffold</span><span class="token punctuation">(</span>
      body<span class="token punctuation">:</span> <span class="token function">Shortcuts</span><span class="token punctuation">(</span>
        shortcuts<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token function">SingleActivator</span><span class="token punctuation">(</span>LogicalKeyboardKey<span class="token punctuation">.</span>keyC<span class="token punctuation">,</span>
              control<span class="token punctuation">:</span> <span class="token operator">!</span>Platform<span class="token punctuation">.</span>isMacOS<span class="token punctuation">,</span> meta<span class="token punctuation">:</span> Platform<span class="token punctuation">.</span>isMacOS<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token function">CopyIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token function">Column</span><span class="token punctuation">(</span>
          mainAxisAlignment<span class="token punctuation">:</span> MainAxisAlignment<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
          children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token function">_Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">_Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">CopyIntent</span> <span class="token keyword">extends</span> <span class="token class-name">Intent</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">CopyIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">_InputAction</span> <span class="token keyword">extends</span> <span class="token class-name">Action</span><span class="token operator">&lt;</span>CopyIntent<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> TextEditingController<span class="token operator">?</span> controller<span class="token punctuation">;</span>
  <span class="token function">_InputAction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>controller<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span>CopyIntent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'copied in input ${controller?.text}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">_Input</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token function">_Input</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Key<span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> TextEditingController _controller <span class="token operator">=</span> <span class="token function">TextEditingController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Actions</span><span class="token punctuation">(</span>
      actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>CopyIntent<span class="token punctuation">:</span> <span class="token function">_InputAction</span><span class="token punctuation">(</span>_controller<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token function">TextField</span><span class="token punctuation">(</span>
        controller<span class="token punctuation">:</span> _controller<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">_SelectAction</span> <span class="token keyword">extends</span> <span class="token class-name">Action</span><span class="token operator">&lt;</span>CopyIntent<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> _SelectState<span class="token operator">?</span> state<span class="token punctuation">;</span>
  <span class="token function">_SelectAction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span>CopyIntent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'copied in select ${state?._value}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">_Select</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">_Select</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Key<span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  State<span class="token operator">&lt;</span>_Select<span class="token operator">&gt;</span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_SelectState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">_SelectState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token operator">&lt;</span>_Select<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  int<span class="token operator">?</span> _value<span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Actions</span><span class="token punctuation">(</span>
      actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        CopyIntent<span class="token punctuation">:</span> <span class="token function">_SelectAction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> DropdownMenu<span class="token operator">&lt;</span>int<span class="token operator">&gt;</span><span class="token punctuation">(</span>
        onSelected<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _value <span class="token operator">=</span> value<span class="token punctuation">,</span>
        dropdownMenuEntries<span class="token punctuation">:</span> List<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> i<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">DropdownMenuEntry</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> v<span class="token punctuation">,</span> label<span class="token punctuation">:</span> v<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div><p>上面我在最顶部包裹了<code>Shortcuts</code>组件并设置了快捷键，快捷键响应的规则是在MacOS上是<code>Command + C</code>，其它平台上是<code>Ctrl + C</code>，并设置了其对应的意图为<code>CopyIntent</code>，然后在输入框组件<code>_Input</code>和下拉框组件<code>_Select</code>中各自实现了<code>CopyIntent</code>对应的操作，这样就实现了快捷键和操作解耦，在快捷键设置的地方可以自行根据不同平台设置，在组件中可以定义自己的响应规则。</p> <h3 id="小结-3"><a href="#小结-3" aria-hidden="true" class="header-anchor">#</a> 小结</h3> <ul><li>可以使用<code>CallbackShortcuts</code>很便捷的定义快捷键及响应</li> <li><code>Shortcuts</code>和<code>Action</code>是为了解耦快捷键和操作的设置，它俩可以配合使用</li> <li><code>Actions</code>也可以单独使用，如直接调用<code>Actions.invoke&lt;CopyIntent&gt;(context, DismissIntent())</code>触发组件关闭</li></ul> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>这篇文章主要是探讨了Flutter Framework层的键盘事件传递的原理。首先，我们可以通过使用<code>HardwareKeyboard.instance.addHandler</code>来全局监听键盘事件，其次可以通过使用<code>Focus</code>组件来将组件设置为焦点节点，当该组件获得焦点时才响应键盘事件，在这个基础上可以使用<code>CallbackShortcuts</code>、或者<code>Shortcuts</code>搭配<code>Actions</code>来设计一些通用的快捷键及响应规则。</p> <h2 id="参考"><a href="#参考" aria-hidden="true" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://docs.flutter.dev/ui/interactivity/focus" target="_blank" rel="noopener noreferrer">Understanding Flutter's keyboard focus system<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.flutter.dev/ui/interactivity/actions-and-shortcuts" target="_blank" rel="noopener noreferrer">Using Actions and Shortcuts<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.youtube.com/watch?v=JCDfh5bs1xc&amp;list=PLjxrf2q8roU23XGwz3Km7sQZFTdB996iG&amp;index=6" target="_blank" rel="noopener noreferrer">Youtube Focus（本周小部件）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit" data-v-8958e280><!----> <div class="last-updated" data-v-8958e280><span class="prefix" data-v-8958e280>Last Updated:</span> <span class="time" data-v-8958e280>10/26/2024, 2:26:21 PM</span></div></footer> <!----> <div id="gitalk-container" data-v-8958e280></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f735c987.js" defer></script><script src="/assets/js/4.1b5f1a26.js" defer></script><script src="/assets/js/3.7354cf96.js" defer></script><script src="/assets/js/38.5cf11128.js" defer></script>
  </body>
</html>
