<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Flutter for Web技术预研 | 幺风</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.da10bf32.css" as="style"><link rel="preload" href="/assets/js/app.f735c987.js" as="script"><link rel="preload" href="/assets/js/4.1b5f1a26.js" as="script"><link rel="preload" href="/assets/js/3.7354cf96.js" as="script"><link rel="preload" href="/assets/js/37.db62ff97.js" as="script"><link rel="prefetch" href="/assets/js/1.91feba10.js"><link rel="prefetch" href="/assets/js/10.c31bcc1b.js"><link rel="prefetch" href="/assets/js/11.642edadc.js"><link rel="prefetch" href="/assets/js/12.e9bb10d9.js"><link rel="prefetch" href="/assets/js/13.bdd95be6.js"><link rel="prefetch" href="/assets/js/14.b6c81b34.js"><link rel="prefetch" href="/assets/js/15.b5139249.js"><link rel="prefetch" href="/assets/js/16.1ade8e0c.js"><link rel="prefetch" href="/assets/js/17.f0b30fb5.js"><link rel="prefetch" href="/assets/js/18.1c883b67.js"><link rel="prefetch" href="/assets/js/19.3e639663.js"><link rel="prefetch" href="/assets/js/20.74962acf.js"><link rel="prefetch" href="/assets/js/21.f837615d.js"><link rel="prefetch" href="/assets/js/22.933fde40.js"><link rel="prefetch" href="/assets/js/23.9334c5ee.js"><link rel="prefetch" href="/assets/js/24.ef408fc2.js"><link rel="prefetch" href="/assets/js/25.f9800b90.js"><link rel="prefetch" href="/assets/js/26.f56ce7bf.js"><link rel="prefetch" href="/assets/js/27.267e0efb.js"><link rel="prefetch" href="/assets/js/28.1aafaa74.js"><link rel="prefetch" href="/assets/js/29.bf71bb2d.js"><link rel="prefetch" href="/assets/js/30.65608550.js"><link rel="prefetch" href="/assets/js/31.c5de1bf4.js"><link rel="prefetch" href="/assets/js/32.43ee74a8.js"><link rel="prefetch" href="/assets/js/33.1efff8a5.js"><link rel="prefetch" href="/assets/js/34.89d049a4.js"><link rel="prefetch" href="/assets/js/35.6b5e7256.js"><link rel="prefetch" href="/assets/js/36.1be005db.js"><link rel="prefetch" href="/assets/js/38.5cf11128.js"><link rel="prefetch" href="/assets/js/39.fa355553.js"><link rel="prefetch" href="/assets/js/40.7490c5e3.js"><link rel="prefetch" href="/assets/js/41.4e813bfa.js"><link rel="prefetch" href="/assets/js/42.93650a8e.js"><link rel="prefetch" href="/assets/js/43.9f1ac82d.js"><link rel="prefetch" href="/assets/js/44.bd781139.js"><link rel="prefetch" href="/assets/js/45.2c5e635b.js"><link rel="prefetch" href="/assets/js/46.50f53b28.js"><link rel="prefetch" href="/assets/js/47.5478a007.js"><link rel="prefetch" href="/assets/js/48.ec71092b.js"><link rel="prefetch" href="/assets/js/49.f17a1618.js"><link rel="prefetch" href="/assets/js/5.4c86b808.js"><link rel="prefetch" href="/assets/js/50.b1e9909e.js"><link rel="prefetch" href="/assets/js/51.777f406a.js"><link rel="prefetch" href="/assets/js/52.f3a47314.js"><link rel="prefetch" href="/assets/js/53.8bda39e8.js"><link rel="prefetch" href="/assets/js/54.6bdd66b2.js"><link rel="prefetch" href="/assets/js/55.d3af29b9.js"><link rel="prefetch" href="/assets/js/56.5e98aed3.js"><link rel="prefetch" href="/assets/js/57.8fac4797.js"><link rel="prefetch" href="/assets/js/58.1f764b7f.js"><link rel="prefetch" href="/assets/js/59.cd677a6a.js"><link rel="prefetch" href="/assets/js/6.d79a3977.js"><link rel="prefetch" href="/assets/js/60.83d74725.js"><link rel="prefetch" href="/assets/js/61.e61ccd9b.js"><link rel="prefetch" href="/assets/js/62.444cc809.js"><link rel="prefetch" href="/assets/js/63.157bbc00.js"><link rel="prefetch" href="/assets/js/64.2ec80c70.js"><link rel="prefetch" href="/assets/js/65.d35a0001.js"><link rel="prefetch" href="/assets/js/66.6f92e582.js"><link rel="prefetch" href="/assets/js/67.9d51e14d.js"><link rel="prefetch" href="/assets/js/68.5675c3e2.js"><link rel="prefetch" href="/assets/js/69.e536d7ac.js"><link rel="prefetch" href="/assets/js/7.0dcc7463.js"><link rel="prefetch" href="/assets/js/70.e187963b.js"><link rel="prefetch" href="/assets/js/71.09bda95d.js"><link rel="prefetch" href="/assets/js/72.aefd789f.js"><link rel="prefetch" href="/assets/js/73.20936a8d.js"><link rel="prefetch" href="/assets/js/74.d17921e6.js"><link rel="prefetch" href="/assets/js/75.0ff9c5e9.js"><link rel="prefetch" href="/assets/js/76.479d210c.js"><link rel="prefetch" href="/assets/js/77.c5443f0d.js"><link rel="prefetch" href="/assets/js/78.666b2fe9.js"><link rel="prefetch" href="/assets/js/79.949a1f44.js"><link rel="prefetch" href="/assets/js/8.67e8e6f2.js"><link rel="prefetch" href="/assets/js/9.70c87633.js">
    <link rel="stylesheet" href="/assets/css/0.styles.da10bf32.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container reform"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="幺风" class="logo"> <span class="site-name can-hide">幺风</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><span class="reform-jia" style="font-size:1rem;"></span>
主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-zhi"></span> <span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link"><!---->
前端</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/" class="nav-link router-link-active"><!---->
Flutter</a></li><li class="dropdown-item"><!----> <a href="/blog/coding/" class="nav-link"><!---->
学习思考</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/" class="nav-link"><!---->
算法与数据结构</a></li><li class="dropdown-item"><!----> <a href="/blog/reading/" class="nav-link"><!---->
阅读笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/reflection/" class="nav-link"><!---->
思考</a></li><li class="dropdown-item"><!----> <a href="/blog/canvas/" class="nav-link"><!---->
渲染相关</a></li><li class="dropdown-item"><!----> <a href="/blog/gesture/" class="nav-link"><!---->
事件相关</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-shuben"></span> <span class="title">文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/vuepress-theme-reform.html" class="nav-link"><!---->
vuepress-theme-reform</a></li><li class="dropdown-item"><!----> <a href="/document/弹幕插件文档.html" class="nav-link"><!---->
弹幕插件文档</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><!---->
标签云</a></div><div class="nav-item"><a href="/about/" class="nav-link"><!---->
关于我</a></div> <a href="https://github.com/xuzhongpeng" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><span class="reform-jia" style="font-size:1rem;"></span>
主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-zhi"></span> <span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link"><!---->
前端</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/" class="nav-link router-link-active"><!---->
Flutter</a></li><li class="dropdown-item"><!----> <a href="/blog/coding/" class="nav-link"><!---->
学习思考</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/" class="nav-link"><!---->
算法与数据结构</a></li><li class="dropdown-item"><!----> <a href="/blog/reading/" class="nav-link"><!---->
阅读笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/reflection/" class="nav-link"><!---->
思考</a></li><li class="dropdown-item"><!----> <a href="/blog/canvas/" class="nav-link"><!---->
渲染相关</a></li><li class="dropdown-item"><!----> <a href="/blog/gesture/" class="nav-link"><!---->
事件相关</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-shuben"></span> <span class="title">文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/vuepress-theme-reform.html" class="nav-link"><!---->
vuepress-theme-reform</a></li><li class="dropdown-item"><!----> <a href="/document/弹幕插件文档.html" class="nav-link"><!---->
弹幕插件文档</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><!---->
标签云</a></div><div class="nav-item"><a href="/about/" class="nav-link"><!---->
关于我</a></div> <a href="https://github.com/xuzhongpeng" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Flutter for Web技术预研</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#介绍" class="sidebar-link">介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#现有网站案例" class="sidebar-link">现有网站案例</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#使用" class="sidebar-link">使用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#两种编译模式" class="sidebar-link">两种编译模式</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#渲染模式" class="sidebar-link">渲染模式</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#pwa" class="sidebar-link">PWA</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#平台兼容" class="sidebar-link">平台兼容</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#通过kisweb判断是否在web平台" class="sidebar-link">通过kIsWeb判断是否在Web平台</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#有条件导入与导出文件" class="sidebar-link">有条件导入与导出文件</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#federated-plugin" class="sidebar-link">Federated plugin</a></li></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#dart与javascript互调" class="sidebar-link">Dart与JavaScript互调</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#dart调用javascript" class="sidebar-link">Dart调用JavaScript</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#javascript调用dart" class="sidebar-link">JavaScript调用Dart</a></li></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#首屏加载" class="sidebar-link">首屏加载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#资源下载" class="sidebar-link">资源下载</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#拆分文件" class="sidebar-link">拆分文件</a></li></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#路由兼容" class="sidebar-link">路由兼容</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#方案1-升级到navigaoion2-0并添加兼容uri调整" class="sidebar-link">方案1: 升级到Navigaoion2.0并添加兼容URI调整</a></li><li class="sidebar-sub-header"><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#方案2：使用go-router" class="sidebar-link">方案2：使用go_router</a></li></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#浏览器兼容性" class="sidebar-link">浏览器兼容性</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#疑难问题记录" class="sidebar-link">疑难问题记录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/flutter/Flutter_for_Web%E6%8A%80%E6%9C%AF%E9%A2%84%E7%A0%94.html#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page" data-v-8958e280> <section class="tags" data-v-8958e280><span class="tagPopup" data-v-8958e280><a href="/tags/?tag=Flutter" class="tag" data-v-8958e280>Flutter</a></span><span class="tagPopup" data-v-8958e280><a href="/tags/?tag=Dart" class="tag" data-v-8958e280>Dart</a></span><span class="tagPopup" data-v-8958e280><a href="/tags/?tag=Flutter%20Web" class="tag" data-v-8958e280>Flutter Web</a></span></section> <div class="content theme-default-content content__default" data-v-8958e280><h2 id="介绍"><a href="#介绍" aria-hidden="true" class="header-anchor">#</a> 介绍</h2> <p><a href="https://flutter.dev/" target="_blank" rel="noopener noreferrer">Flutter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是Google推出并<a href="https://github.com/flutter" target="_blank" rel="noopener noreferrer">开源<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的跨平台开发框架，它采用Skia渲染并兼容了Android、iOS、Mac、Windows、Linux及Web，Flutter在2.0版本正式发布了对Web的支持</p> <p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/34.png" alt=""></p> <p>Flutter使用Dart开发，Dart本身能通过dart2js将Dart语言转成JavaScript。在Flutter中分为框架层和引擎层。框架层提供了布局渲染更新方式和手势等抽象能力，还提供了常用的组件。引擎层提供了平台差异的抽象同时也抹平了不同平台差异。Flutter for Web通过映射web平台API的代码来取代移动应用所使用的底层C++渲染引擎。</p> <p><a href="https://free.aliyun.com/product/eds" target="_blank" rel="noopener noreferrer">无影<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>本身是一个支持多端的产品，目前支持MacOS、Windows、零终端(Linux)、iOS、Android及<a href="https://wuying.aliyun.com/polymerization" target="_blank" rel="noopener noreferrer">Web端<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，目前PC三端都是通过同一个Flutter工程输出，iOS和Android因为逻辑与UI差异很大，没有使用跟PC端同一工程来开发，但是部分功能如登录逻辑也是通过与PC端引入同一个库的形式集成的。Web端一直采用的是纯Web开发，但目前无影的产品功能迭代很快，经常一个版本UI及功能都有重大变化，目前两端使用不同技术开发给我们开发周期及功能同步带来了很大的挑战。在我们Flutter项目将Flutter引擎升级到3.0.2的时机，提出了将我们Flutter项目转Web的需求，于是有了这次技术预研。</p> <h2 id="现有网站案例"><a href="#现有网站案例" aria-hidden="true" class="header-anchor">#</a> 现有网站案例</h2> <ul><li>https://code.irobot.com/#/</li> <li>https://www.omnichess.club/</li> <li>https://rive.app</li> <li>https://demo.invoiceninja.com/#/</li></ul> <h2 id="使用"><a href="#使用" aria-hidden="true" class="header-anchor">#</a> 使用</h2> <p>环境</p> <blockquote><p>Flutter: 3.0.2
MacOS: 12.0.1</p></blockquote> <p>确保Flutter版本在2.0及以上，使用下面命令创建项目，默认会生成支持Web的项目结构</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>flutter create {PROJECTNAME}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果想要对已有项目的支持，只需要控制台进入项目，执行</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>flutter create --platforms web .
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>想要知道项目是否支持Web，可以查看项目文件夹是否包含<code>web</code>文件夹，其默认生成的结构如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>web
├─ favicon.png 
├─ icons
│    ├─ Icon-192.png
│    ├─ Icon-512.png
│    ├─ Icon-maskable-192.png
│    └─ Icon-maskable-512.png
├─ index.html  入口文件，通过引入编译后的JS渲染页面
└─ manifest.json  配置PWA
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>注：icons里的图片是与PWA配合使用，当用户将项目安装到本地时(<a href="https://developer.mozilla.org/zh-CN/docs/Web/Progressive_web_apps" target="_blank" rel="noopener noreferrer">PWA<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)，该图标会被当做启动图标使用</p></blockquote> <p>然后我们就可以在控制台输入下面命令启动项目了</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>flutter run -d chrome
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/50.png" alt=""></p> <h2 id="两种编译模式"><a href="#两种编译模式" aria-hidden="true" class="header-anchor">#</a> 两种编译模式</h2> <p>flutter提供了两种编译模式，分别适用于开发环境和生产环境。</p> <ul><li>flutterdev: 一种支持增量开发编译模式，可实现代码快速生效。当我们使用flutter run启动项目时就是使用的该方式，它可像开发客户端应用一样支持<code>hot reload</code>和<code>hot restart</code>。</li> <li>dart2js: 它是一个优化的编译器，可以将Dart代码编译为快速、紧凑的JavaScript代码，可以极大提高代码的包大小及运行效率。</li></ul> <h2 id="渲染模式"><a href="#渲染模式" aria-hidden="true" class="header-anchor">#</a> 渲染模式</h2> <p>Flutter for Web提供了两种渲染模式，HTML和CanvasKit，我们在编译的时候可以选择不同的编译模式</p> <ul><li>auto（默认）自动选择要使用的渲染器。当应用程序在移动浏览器中运行时，此选项选择HTML渲染器，当应用程序在桌面浏览器中运行时，采用CanvasKit渲染器。</li> <li>html 使用HTML渲染器。使用HTML元素、CSS、Canvas元素和SVG元素的组合来渲染。此渲染方式采用的包大小更小。</li> <li>canvaskit 使用CanvasKit渲染器。使用<code>WebAssembly</code>与<code>WebGL</code>渲染，将得到与桌面端渲染的一致性，且相比HTML渲染有更高的性能。但是它相比HTML渲染会多7MB左右的包大小(当前使用<a href="https://unpkg.com/browse/canvaskit-wasm@0.33.0/bin/" target="_blank" rel="noopener noreferrer">canvaskit0.33.0<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。</li></ul> <p>我们可以通过编译时传入参数来指定渲染模式</p> <div class="language-shell line-numbers-mode"><pre class="language-text"><code>flutter run -d chrome --web-renderer html
flutter build web --web-renderer canvaskit
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>或者在index.html中注入JavaScript的方式来指定渲染模式（只有编译时选择了auto才生效）</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  window<span class="token punctuation">.</span>flutterWebRenderer <span class="token operator">=</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">;</span> <span class="token comment">//or</span>
  <span class="token comment">// window.flutterWebRenderer = &quot;canvaskit&quot;;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>html模式相比canvaskit除了渲染性能更低，还有一些其它问题</p> <ul><li>不支持<code>Image.toByteData</code></li> <li>不支持<code>OffsetLayer.toImage</code>和<code>Scene.toImage</code></li> <li>无法访问动画中的帧数据(Codec.getNextFrame,frameCount始终为1，repetitionCount始终为0)</li> <li>不支持<code>ImageShader</code></li> <li>图像上使用shader功能支持有限</li> <li>图片无法控制内存，dispose回调不会执行（图片内存管理都被浏览器接管了）</li></ul> <p><a href="https://skia.org/docs/user/modules/canvaskit/" target="_blank" rel="noopener noreferrer">CanvasKit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是一种采用<code>Skia</code>开发然后通过<code>WebAssembly</code>和<code>WebGL</code>渲染的技术。我们引入<code>canvaskit.js</code>和<code>canvaskit.wasm</code>包后，就可以通过JavaScript使用Skia API来绘制页面，<a href="https://skia.org/docs/user/modules/quickstart/" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>有一个简单的例子。</p> <h2 id="pwa"><a href="#pwa" aria-hidden="true" class="header-anchor">#</a> PWA</h2> <p>Flutter转成Web后会默认会把项目编译成一个<a href="https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps" target="_blank" rel="noopener noreferrer">PWA<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>项目(<a href="https://web.dev/learn/pwa/" target="_blank" rel="noopener noreferrer">学习资料<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)，它会提供一个PWA WEB清单文件并生成一个<code>flutter_server_worker.js</code>文件，<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers" target="_blank" rel="noopener noreferrer">Service Workers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对Flutter内容进行缓存，当第一次加载完成后，再次请求资源下载都会走缓存。</p> <p>当我们在Chrome中打开一个PWA项目时，浏览器url右边会出现一个下载按钮，下载后Web应用会被当成一个类似客户端应用来使用。</p> <p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/21.png" alt=""></p> <p>这就相当于一个简化版的无影客户端。</p> <p>Flutter默认启动了<code>PWA</code>，我们可以编辑<code>manifest.json</code>文件来更改项目配置，具体可以查看<a href="https://developer.mozilla.org/en-US/docs/Web/Manifest" target="_blank" rel="noopener noreferrer">Manifest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来学习如何配置。</p> <p>当然如果我们不想使用<code>PWA</code>，可以在编译时添加<code>--pwa-strategy=none</code>命令来禁止使用它。</p> <h2 id="平台兼容"><a href="#平台兼容" aria-hidden="true" class="header-anchor">#</a> 平台兼容</h2> <p>由于Web平台和MacOS、Windows、Linux平台差异很大，所以很多功能需要针对平台进行改造</p> <h3 id="通过kisweb判断是否在web平台"><a href="#通过kisweb判断是否在web平台" aria-hidden="true" class="header-anchor">#</a> 通过kIsWeb判断是否在Web平台</h3> <p>跟在客户端使用<code>Platform.is*</code>不一样，Flutter是通过<code>kIsWeb</code>来识别是否在Flutter平台，它使用一种巧妙的方式通过比较0与0.0是否同一个值类型来实现的，因为在JavaScript中不区分double和int，而dart中是需要区分的。当我们使用<code>kIsWeb</code>时就像使用<code>Platform.is*</code>一样，如</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>String <span class="token function">getPlatformName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>kIsWeb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'Flutter Web'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Platform<span class="token punctuation">.</span>isMacOS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'MacOS'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在Web环境中，使用<code>Platform</code>会在运行时报错导致代码执行中断(<a href="https://github.com/flutter/flutter/issues/36126" target="_blank" rel="noopener noreferrer">issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)，如果项目要兼容Web平台，需要将项目中的<code>Platform.is*</code>代码都改成兼容代码。你可以自己封装一个类来兼容，如</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:flutter/foundation.dart'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">MYPlatform</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> bool isMacOS <span class="token operator">=</span> <span class="token operator">!</span>kIsWeb <span class="token operator">&amp;&amp;</span> defaultTargetPlatform <span class="token operator">==</span> TargetPlatform<span class="token punctuation">.</span>macOS<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> bool isAndroid <span class="token operator">=</span> <span class="token operator">!</span>kIsWeb <span class="token operator">&amp;&amp;</span> defaultTargetPlatform <span class="token operator">==</span> TargetPlatform<span class="token punctuation">.</span>android<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> bool isIOS <span class="token operator">=</span> <span class="token operator">!</span>kIsWeb <span class="token operator">&amp;&amp;</span> defaultTargetPlatform <span class="token operator">==</span> TargetPlatform<span class="token punctuation">.</span>iOS<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> bool isFuchsia <span class="token operator">=</span> <span class="token operator">!</span>kIsWeb <span class="token operator">&amp;&amp;</span> defaultTargetPlatform <span class="token operator">==</span> TargetPlatform<span class="token punctuation">.</span>fuchsia<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> bool isWindows <span class="token operator">=</span> <span class="token operator">!</span>kIsWeb <span class="token operator">&amp;&amp;</span> defaultTargetPlatform <span class="token operator">==</span> TargetPlatform<span class="token punctuation">.</span>windows<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> bool isLinux <span class="token operator">=</span> <span class="token operator">!</span>kIsWeb <span class="token operator">&amp;&amp;</span> defaultTargetPlatform <span class="token operator">==</span> TargetPlatform<span class="token punctuation">.</span>linux<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> bool isWeb <span class="token operator">=</span> kIsWeb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>使用<code>MYPlatform.is*</code>来全局替换<code>Platform.is*</code>。</p> <p>或者可以引入一个三方库<a href="https://pub.dev/packages/universal_platform" target="_blank" rel="noopener noreferrer">universal_platform<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，然后使用<code>UniversalPlatform.is*</code>来替换<code>Platform.is*</code>。</p> <p>顺便提一下，在客户端工程中引入<code>dart:html</code>也会报找不到的错误，我们同样可以引入<a href="https://pub.dev/packages/universal_html" target="_blank" rel="noopener noreferrer">universal_html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>解决。</p> <h3 id="有条件导入与导出文件"><a href="#有条件导入与导出文件" aria-hidden="true" class="header-anchor">#</a> 有条件导入与导出文件</h3> <p>Flutter提供了导入导出时通过条件判断来支持不同平台引入不同实现。<a href="https://dart.dev/guides/libraries/create-library-packages#conditionally-importing-and-exporting-library-files" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:flutter3_demo/ffi/show_image_platform_interface.dart'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dart<span class="token punctuation">.</span><span class="token keyword">library</span><span class="token punctuation">.</span>io<span class="token punctuation">)</span> <span class="token string">'show_image_io.dart'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dart<span class="token punctuation">.</span><span class="token keyword">library</span><span class="token punctuation">.</span>html<span class="token punctuation">)</span> <span class="token string">'show_image_web.dart'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过这样的代码在静态编译时会默认引入<code>show_image_platform_interface.dart</code>代码，当在开发或者打包编译时，如果是Native项目，会引入<code>show_image_io.dart</code>文件，如果是Web项目，会引入<code>show_image_web.dart</code>文件。需要注意的是，我们需要在<code>show_image_io.dart</code>和<code>show_image_web.dart</code>拥有相同名称的类与方法或者变量。</p> <p>这种方式是通过检查<code>dart:*</code>库是否存在实现的，比如在客户端应用程序中会导入<code>dart:io</code>库，所以相应的上面会导入<code>show_image_io.dart</code>，Web程序中会导入<code>dart:html</code>，所以会导入<code>show_image_web.dart</code>文件。</p> <p>library的<a href="https://dart.dev/guides/libraries" target="_blank" rel="noopener noreferrer">导入规则<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(部分库在Flutter中不会被引入，所以没列出来)</p> <ul><li>Core: dart:core, dart:async, dart:collection, dart:convert, dart:developer, dart:math, dart:typed_data</li> <li>Native Platform: dart:ffi, dart:io, dart:isolate</li> <li>Web: dart:html, dart:js, dar:js_util, package:js</li></ul> <h3 id="federated-plugin"><a href="#federated-plugin" aria-hidden="true" class="header-anchor">#</a> Federated plugin</h3> <p><a href="https://docs.flutter.dev/development/packages-and-plugins/developing-packages" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Flutter提供了一种新的插件开发方式<code>Federated plugin</code>，我们可以在插件的<code>pubspec.yaml</code>文件中指定对应的平台实现</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">flutter</span><span class="token punctuation">:</span>
  <span class="token key atrule">plugin</span><span class="token punctuation">:</span>
    <span class="token key atrule">platforms</span><span class="token punctuation">:</span>
      <span class="token key atrule">android</span><span class="token punctuation">:</span>
        <span class="token key atrule">package</span><span class="token punctuation">:</span> com.example.hello
        <span class="token key atrule">pluginClass</span><span class="token punctuation">:</span> HelloPlugin
      <span class="token key atrule">ios</span><span class="token punctuation">:</span>
        <span class="token key atrule">pluginClass</span><span class="token punctuation">:</span> HelloPlugin
      <span class="token key atrule">macos</span><span class="token punctuation">:</span>
        <span class="token key atrule">pluginClass</span><span class="token punctuation">:</span> HelloPlugin
      <span class="token key atrule">web</span><span class="token punctuation">:</span>
        <span class="token key atrule">pluginClass</span><span class="token punctuation">:</span> HelloPlugin
        <span class="token key atrule">fileName</span><span class="token punctuation">:</span> hello_web.dart

<span class="token key atrule">environment</span><span class="token punctuation">:</span>
  <span class="token key atrule">sdk</span><span class="token punctuation">:</span> <span class="token string">&quot;&gt;=2.1.0 &lt;3.0.0&quot;</span>
  <span class="token key atrule">flutter</span><span class="token punctuation">:</span> <span class="token string">&quot;&gt;=1.12.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>例如上面例子，我们可以针对<code>Web</code>平台单独实现<code>hello_web.dart</code>，在<code>hello_web.dart</code>中，我们需要对插件进行注册。</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">HelloPluginWindows</span> <span class="token keyword">extends</span> <span class="token class-name">HelloPluginPlatform</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerWith</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    HelloPluginPlatform<span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token function">HelloPluginWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>更多例子可以参考官方插件<a href="https://github.com/flutter/plugins/blob/main/packages/url_launcher/url_launcher/pubspec.yaml" target="_blank" rel="noopener noreferrer">url_launcher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的实现。</p> <h2 id="dart与javascript互调"><a href="#dart与javascript互调" aria-hidden="true" class="header-anchor">#</a> Dart与JavaScript互调</h2> <p>虽然现在Flutter生态很好，有很多三方库可以使用，但是相比Web生态还是差太多了，在使用<code>Flutter</code>开发时能够与<code>JavaScript</code>的函数互调是一个比较重要的能力。Flutter提供了<code>dart:js_utils</code>和<code>dart:js</code>工具来与Web端的<code>JavaScript</code>互相调用。</p> <h3 id="dart调用javascript"><a href="#dart调用javascript" aria-hidden="true" class="header-anchor">#</a> Dart调用JavaScript</h3> <p>在web文件夹下新建<code>hello.js</code></p> <div class="language-JavaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 同步函数</span>
window<span class="token punctuation">.</span><span class="token function-variable function">bindHello</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> i<span class="token operator">++</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 异步函数</span>
window<span class="token punctuation">.</span><span class="token function-variable function">bindHelloAsync</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>i<span class="token operator">++</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>上面创建了一个同步函数和异步函数，分别演示Dart调用JavaScript的同步函数和异步函数方式。我们需要把函数绑定到window上，Dart才能通过window拿到函数。</p> <p>在<code>index.html</code>中引入<code>hello.js</code></p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hello.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">defer</span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后在Dart中分别调用同步函数和异步函数</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'dart:html'</span> <span class="token operator">as</span> html<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'dart:js'</span> <span class="token operator">as</span> js<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'dart:js_util'</span> <span class="token operator">as</span> js_util<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">CallJS</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> bool <span class="token function">callHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bool result <span class="token operator">=</span> js<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">callMethod</span><span class="token punctuation">(</span><span class="token string">'bindHello'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Flutter Web Sync'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> Future<span class="token operator">&lt;</span>bool<span class="token operator">&gt;</span> <span class="token function">callHelloAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> js_util
        <span class="token punctuation">.</span><span class="token function">callMethod</span><span class="token punctuation">(</span>html<span class="token punctuation">.</span>window<span class="token punctuation">,</span> <span class="token string">'bindHelloAsync'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Flutter Web Async'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool returnObj <span class="token operator">=</span> <span class="token keyword">await</span> js_util<span class="token punctuation">.</span>promiseToFuture<span class="token operator">&lt;</span>bool<span class="token operator">&gt;</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> returnObj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Dart调用JavaScript有两种方式，可以通过<code>js.context.callMethod(Object method, [List&lt;dynamic&gt;? args])</code>或者<code>js_util.callMethod(html.window,Object method, [List&lt;dynamic&gt;? args])</code>，<code>js.context</code>在Web端相当于<code>window</code>。</p> <p>当我们调用<code>callHello</code>时，就能拿到<code>JavaScript</code>执行后的返回结果，调用<code>callHelloAsync</code>时能拿到<code>JavaScript</code>异步的执行结果</p> <h3 id="javascript调用dart"><a href="#javascript调用dart" aria-hidden="true" class="header-anchor">#</a> JavaScript调用Dart</h3> <h4 id="同步"><a href="#同步" aria-hidden="true" class="header-anchor">#</a> 同步</h4> <p>可以通过<code>js_util.setProperty</code>来提供<code>JavaScript</code>调用<code>Dart</code>能力，例如</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'dart:html'</span> <span class="token operator">as</span> html<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'dart:js'</span> <span class="token operator">as</span> js<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'dart:js_util'</span> <span class="token operator">as</span> js_util<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">bindJS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  js_util<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>html<span class="token punctuation">.</span>window<span class="token punctuation">,</span> <span class="token string">&quot;callHello&quot;</span><span class="token punctuation">,</span> js<span class="token punctuation">.</span><span class="token function">allowInterop</span><span class="token punctuation">(</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'$args from dart'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们可以通过<code>setProperty</code>第三个参数可以是值类型、数组(<code>js.JsArray</code>)、对象(<code>js.JsObject</code>)等，我们可以通过使用<code>js.allowInterop</code>将Dart函数转成JavaScript函数。</p> <p>然后在JavaScript中调用</p> <div class="language-JavaScript line-numbers-mode"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">callHello</span><span class="token punctuation">(</span><span class="token string">'Flutter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="异步"><a href="#异步" aria-hidden="true" class="header-anchor">#</a> 异步</h4> <p>Flutter并没有提供异步JavaScript调用Dart的方式，但我们可以通过使用<code>Dart</code>调<code>JavaScript</code>的能力间接达到异步能力。</p> <p>Dart代码：</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>js_util<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>html<span class="token punctuation">.</span>window<span class="token punctuation">,</span> <span class="token string">&quot;callHelloAsync&quot;</span><span class="token punctuation">,</span>
        js<span class="token punctuation">.</span><span class="token function">allowInterop</span><span class="token punctuation">(</span><span class="token punctuation">(</span>returnName<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// do some thing async</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收参数</span>
    <span class="token keyword">await</span> Future<span class="token punctuation">.</span><span class="token function">delayed</span><span class="token punctuation">(</span><span class="token function">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    js<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">callMethod</span><span class="token punctuation">(</span>returnName<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Result from Dart'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>JavaScript代码</p> <div class="language-JavaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">callDartAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">callHelloAsync</span><span class="token punctuation">(</span><span class="token string">'callResult'</span><span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">callResult</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span>callResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样<code>JavaScript</code>调用<code>callDartAsync</code>函数就能拿到Dart异步执行后返回的结果了。</p> <h2 id="首屏加载"><a href="#首屏加载" aria-hidden="true" class="header-anchor">#</a> 首屏加载</h2> <h3 id="资源下载"><a href="#资源下载" aria-hidden="true" class="header-anchor">#</a> 资源下载</h3> <p>当Flutter项目转成web后有几个文件比较大</p> <ol><li>main.dart.js 2.0+ MB</li> <li>canvaskit.wasm 7.0 MB</li> <li>MaterialIcons-Regular.otf 等字体或图标文件</li></ol> <p>Flutter提供了一系列JavaScript API来控制整个资源下载及加载过程，在<code>index.html</code>默认会生成这样的函数调用</p> <div class="language-JavaScript line-numbers-mode"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// flutter.js加载完成，开始下载main.dart.js资源</span>
    _flutter<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">loadEntrypoint</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      serviceWorker<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          serviceWorkerVersion<span class="token punctuation">:</span> serviceWorkerVersion<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">engineInitializer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 加载main.dart.js，下载canvaskit.js canvaskit.wasm 及字体资源</span>
      <span class="token keyword">return</span> engineInitializer<span class="token punctuation">.</span><span class="token function">initializeEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">appRunner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 启动引擎，渲染界面</span>
      <span class="token keyword">return</span> appRunner<span class="token punctuation">.</span><span class="token function">runApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// load end</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>当index.html开始加载到第一帧显示，Flutter提供了一系列加载函数并加载</p> <ul><li>window.addEventListener('load'): index.html中的flutter.js文件下载成功</li> <li>loadEntrypoint: 下载favicon.png、main.dart.js、manifest.json等文件</li> <li>initializeEngine: 加载main.dart.js，下载canvaskit.js、canvaskit.wasm、FontManifest.json、MaterialIcons-Regular.otf等项目中使用的资源</li> <li>runApp: 运行app</li></ul> <p>我针对该过程测试了大致的时间消耗</p> <table><thead><tr><th>网速</th> <th>begin(s)</th> <th>load(s)</th> <th>loadEntrypoint(s)</th> <th>initializeEngine(s)</th> <th>runApp(s)</th></tr></thead> <tbody><tr><td>4G(4Mb/s)</td> <td>0</td> <td>0.22</td> <td>9.96</td> <td>31.346</td> <td>31.447</td></tr> <tr><td>WIFI(30Mb/s)</td> <td>0</td> <td>0.12</td> <td>2.115</td> <td>6.645</td> <td>6.645</td></tr> <tr><td>比例(%)</td> <td>0</td> <td>5</td> <td>26</td> <td>67</td> <td>2</td></tr></tbody></table> <p>这样，我们就可以根据上面的Web资源加载函数配合上表的每一段函数执行时间比例做一个首屏资源加载进度条来提高用户体验。如果在我们Flutter Web页面前面还有其它Web页面，也可以利用这些API对资源进行预加载。</p> <h3 id="拆分文件"><a href="#拆分文件" aria-hidden="true" class="header-anchor">#</a> 拆分文件</h3> <p>整个项目都打包到一个文件中，会使首次下载文件变大，Flutter提供了一些方式来拆分文件，只有在加载对应的页面时才下载对应文件，<a href="https://github.com/flutter/flutter/issues/50196" target="_blank" rel="noopener noreferrer">相关资料<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>代码方案</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'mywidget.dart'</span> <span class="token keyword">deferred</span> <span class="token operator">as</span> foo
<span class="token keyword">final</span> Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> loadedLibrary <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">FutureBuilder</span><span class="token punctuation">(</span>future<span class="token punctuation">:</span> loadedLibrary<span class="token punctuation">,</span> builder<span class="token punctuation">:</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> foo<span class="token punctuation">.</span><span class="token function">MyWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们可以使用<code>deferred as</code>来引入其它文件，拿到的<code>foo</code>会有一个<code>loadLibrary</code>函数，它返回一个Future，当这个Future返回时，就能拿到引入文件的具体函数并执行了。</p> <p><code>flutter build web</code>后，会在文件夹中生成一个<code>main.dart.js_x.part.js</code>文件，它会在Flutter调用上面<code>FutureBuilder</code>时才下载文件并加载。一般情况下，我们可以使用它对不同页面进行路由拆分以获得最大收益。</p> <h2 id="路由兼容"><a href="#路由兼容" aria-hidden="true" class="header-anchor">#</a> 路由兼容</h2> <p>传统的路由方式也能在Flutter Web上使用，但是不会更新浏览器的url，所以需要针对传统路由进行兼容处理。</p> <h3 id="方案1-升级到navigaoion2-0并添加兼容uri调整"><a href="#方案1-升级到navigaoion2-0并添加兼容uri调整" aria-hidden="true" class="header-anchor">#</a> 方案1: 升级到Navigaoion2.0并添加兼容URI调整</h3> <p>Navigator2.0网络上有很多文章及教程，展开讲很啰嗦。可以参考<a href="https://medium.com/flutter-community/flutter-navigator-2-0-for-authentication-and-bootstrapping-part-1-introduction-d7b6dfdd0849" target="_blank" rel="noopener noreferrer">Flutter Navigator 2.0 for Authentication and Bootstrapping<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它是一篇关于Navigator 2.0使用系列文章，<a href="https://medium.com/geekculture/flutter-navigator-2-0-for-authentication-and-bootstrapping-part-5-web-eeb4835804df" target="_blank" rel="noopener noreferrer">最后一篇<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>讲的是Web适配。</p> <h3 id="方案2：使用go-router"><a href="#方案2：使用go-router" aria-hidden="true" class="header-anchor">#</a> 方案2：使用go_router</h3> <p><a href="https://pub.dev/packages/go_router" target="_blank" rel="noopener noreferrer">go_router<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是Flutter官方基于Navigator 2.0出的一个响应式的三方库，它提供了更多路由通用功能，相比我们直接使用<code>Navigator 2.0</code>，很多功能不需要再重复造轮子。</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:go_router/go_router.dart'</span><span class="token punctuation">;</span>

<span class="token comment">// GoRouter configuration</span>
<span class="token keyword">final</span> _router <span class="token operator">=</span> <span class="token function">GoRouter</span><span class="token punctuation">(</span>
  initialLocation<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
  routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token function">GoRoute</span><span class="token punctuation">(</span>
      path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
      builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">HomeScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">GoRoute</span><span class="token punctuation">(</span>
      path<span class="token punctuation">:</span> <span class="token string">'/users/:userId'</span><span class="token punctuation">,</span>
      builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">const</span> <span class="token function">UserScreen</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> state<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'userId'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">MyApp</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> MaterialApp<span class="token punctuation">.</span><span class="token function">router</span><span class="token punctuation">(</span>
      routerDelegate<span class="token punctuation">:</span> _router<span class="token punctuation">.</span>routerDelegate<span class="token punctuation">,</span>
      routeInformationParser<span class="token punctuation">:</span> _router<span class="token punctuation">.</span>routeInformationParser<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>然后可以通过</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>context<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token string">'/users/123'</span><span class="token punctuation">)</span>
<span class="token comment">//或者</span>
GoRouter<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/users/123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>进行路由跳转。</p> <p>更多可以点击<a href="https://pub.dev/documentation/go_router/latest/index.html" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="浏览器兼容性"><a href="#浏览器兼容性" aria-hidden="true" class="header-anchor">#</a> 浏览器兼容性</h2> <ul><li>Chrome: 84版本及以上</li> <li>Firefox: 72.9版本及以上</li> <li>Safari: 9及以上（对应MacOS10.11)</li> <li>Edge: 1.2.0及以上</li></ul> <h2 id="疑难问题记录"><a href="#疑难问题记录" aria-hidden="true" class="header-anchor">#</a> 疑难问题记录</h2> <ol><li>构建的项目中通过<code>https://unpkg.com/canvaskit-wasm@0.33.0/bin/</code>来引入<code>canvaskit.js</code>和<code>canvaskit.wasm</code></li></ol> <p>相关<a href="https://github.com/flutter/flutter/issues/70101" target="_blank" rel="noopener noreferrer">issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>如果使用<code>canvasKit</code>渲染模式构建web，会引入<code>canvaskit.js</code>和<code>canvaskit.wasm</code>文件，默认它会指向一个默认的cdn地址，这个cdn地址可能在国内无法访问，解决办法是在index.html中添加script脚本指定文件地址</p> <div class="language-JavaScript line-numbers-mode"><pre class="language-javascript"><code>window<span class="token punctuation">.</span>flutterConfiguration <span class="token operator">=</span> <span class="token punctuation">{</span>
    canvasKitBaseUrl<span class="token punctuation">:</span> <span class="token string">&quot;/canvaskit/&quot;</span> <span class="token comment">// 指向本目录的canvaskit文件夹下，编译会自动生成该文件；或者指向自己的CDN地址</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>或者在构建时指定</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>flutter build web --web-renderer canvaskit --dart-define=FLUTTER_WEB_CANVASKIT_URL=/canvaskit/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>构建未生成<code>flutter.js</code>文件和<code>canvaskit</code>文件夹</li></ol> <p>如果构建未指定构建类型，可能会使用html渲染方式构建，所以需要构建时指定<code>flutter build web --web-renderer canvaskit</code></p> <ol start="3"><li>构建后项目中会有一个字体文件指向了如<code>https://fonts.gstatic.com/s/roboto/</code>等地址</li></ol> <p>相关<a href="https://github.com/flutter/flutter/issues/77580" target="_blank" rel="noopener noreferrer">issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，解决方案是先去<a href="https://fonts.google.com/specimen/Roboto" target="_blank" rel="noopener noreferrer">Roboto<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>下载字体文件导入到项目中，然后在项目pubspec.yaml中引入</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">flutter</span><span class="token punctuation">:</span>
  <span class="token key atrule">fonts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">family</span><span class="token punctuation">:</span> Roboto
      <span class="token key atrule">fonts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">asset</span><span class="token punctuation">:</span> assets/Roboto<span class="token punctuation">-</span>Regular.ttf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>目前Flutter for Web逐渐趋于成熟，但是它本身还有一些问题</p> <ol><li>首次下载资源文件太大</li> <li>无法友好支持搜索引擎SEO</li> <li>与客户端API有兼容差异，工程化考验开发者能力</li></ol> <p>相应的也有一些好处</p> <ol><li>支持PWA</li> <li>如果已有Flutter客户端工程，只需要维护一套代码</li></ol> <p>所以这些问题和收益需要团队自己去衡量。这次预研也有很多收获，如果后续在我们工程中应用，我再来分享我们在工程中遇到的挑战与实战干货。</p> <h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <ol><li><a href="https://docs.flutter.dev/development/platform-integration/web/faq" target="_blank" rel="noopener noreferrer">Flutter Dev<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://dart.dev/web" target="_blank" rel="noopener noreferrer">Dart Dev<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zhuanlan.zhihu.com/p/355976725" target="_blank" rel="noopener noreferrer">Flutter Web 支持现已进入稳定版<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mp.weixin.qq.com/s/rxapVTJIGfnqCNzB3S7C4Q" target="_blank" rel="noopener noreferrer">Flutter For Web多端一体化开发和原理分析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <footer class="page-edit" data-v-8958e280><!----> <div class="last-updated" data-v-8958e280><span class="prefix" data-v-8958e280>Last Updated:</span> <span class="time" data-v-8958e280>12/4/2022, 4:20:56 PM</span></div></footer> <!----> <div id="gitalk-container" data-v-8958e280></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f735c987.js" defer></script><script src="/assets/js/4.1b5f1a26.js" defer></script><script src="/assets/js/3.7354cf96.js" defer></script><script src="/assets/js/37.db62ff97.js" defer></script>
  </body>
</html>
