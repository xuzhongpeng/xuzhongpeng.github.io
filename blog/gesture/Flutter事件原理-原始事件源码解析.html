<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>原始手势源码解析 | 幺风</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.da10bf32.css" as="style"><link rel="preload" href="/assets/js/app.f735c987.js" as="script"><link rel="preload" href="/assets/js/4.1b5f1a26.js" as="script"><link rel="preload" href="/assets/js/3.7354cf96.js" as="script"><link rel="preload" href="/assets/js/57.8fac4797.js" as="script"><link rel="prefetch" href="/assets/js/1.91feba10.js"><link rel="prefetch" href="/assets/js/10.c31bcc1b.js"><link rel="prefetch" href="/assets/js/11.642edadc.js"><link rel="prefetch" href="/assets/js/12.e9bb10d9.js"><link rel="prefetch" href="/assets/js/13.bdd95be6.js"><link rel="prefetch" href="/assets/js/14.b6c81b34.js"><link rel="prefetch" href="/assets/js/15.b5139249.js"><link rel="prefetch" href="/assets/js/16.1ade8e0c.js"><link rel="prefetch" href="/assets/js/17.f0b30fb5.js"><link rel="prefetch" href="/assets/js/18.1c883b67.js"><link rel="prefetch" href="/assets/js/19.3e639663.js"><link rel="prefetch" href="/assets/js/20.74962acf.js"><link rel="prefetch" href="/assets/js/21.f837615d.js"><link rel="prefetch" href="/assets/js/22.933fde40.js"><link rel="prefetch" href="/assets/js/23.9334c5ee.js"><link rel="prefetch" href="/assets/js/24.ef408fc2.js"><link rel="prefetch" href="/assets/js/25.f9800b90.js"><link rel="prefetch" href="/assets/js/26.f56ce7bf.js"><link rel="prefetch" href="/assets/js/27.267e0efb.js"><link rel="prefetch" href="/assets/js/28.1aafaa74.js"><link rel="prefetch" href="/assets/js/29.bf71bb2d.js"><link rel="prefetch" href="/assets/js/30.65608550.js"><link rel="prefetch" href="/assets/js/31.c5de1bf4.js"><link rel="prefetch" href="/assets/js/32.43ee74a8.js"><link rel="prefetch" href="/assets/js/33.1efff8a5.js"><link rel="prefetch" href="/assets/js/34.89d049a4.js"><link rel="prefetch" href="/assets/js/35.6b5e7256.js"><link rel="prefetch" href="/assets/js/36.1be005db.js"><link rel="prefetch" href="/assets/js/37.db62ff97.js"><link rel="prefetch" href="/assets/js/38.5cf11128.js"><link rel="prefetch" href="/assets/js/39.fa355553.js"><link rel="prefetch" href="/assets/js/40.7490c5e3.js"><link rel="prefetch" href="/assets/js/41.4e813bfa.js"><link rel="prefetch" href="/assets/js/42.93650a8e.js"><link rel="prefetch" href="/assets/js/43.9f1ac82d.js"><link rel="prefetch" href="/assets/js/44.bd781139.js"><link rel="prefetch" href="/assets/js/45.2c5e635b.js"><link rel="prefetch" href="/assets/js/46.50f53b28.js"><link rel="prefetch" href="/assets/js/47.5478a007.js"><link rel="prefetch" href="/assets/js/48.ec71092b.js"><link rel="prefetch" href="/assets/js/49.f17a1618.js"><link rel="prefetch" href="/assets/js/5.4c86b808.js"><link rel="prefetch" href="/assets/js/50.b1e9909e.js"><link rel="prefetch" href="/assets/js/51.777f406a.js"><link rel="prefetch" href="/assets/js/52.f3a47314.js"><link rel="prefetch" href="/assets/js/53.8bda39e8.js"><link rel="prefetch" href="/assets/js/54.6bdd66b2.js"><link rel="prefetch" href="/assets/js/55.d3af29b9.js"><link rel="prefetch" href="/assets/js/56.5e98aed3.js"><link rel="prefetch" href="/assets/js/58.1f764b7f.js"><link rel="prefetch" href="/assets/js/59.cd677a6a.js"><link rel="prefetch" href="/assets/js/6.d79a3977.js"><link rel="prefetch" href="/assets/js/60.83d74725.js"><link rel="prefetch" href="/assets/js/61.e61ccd9b.js"><link rel="prefetch" href="/assets/js/62.444cc809.js"><link rel="prefetch" href="/assets/js/63.157bbc00.js"><link rel="prefetch" href="/assets/js/64.2ec80c70.js"><link rel="prefetch" href="/assets/js/65.d35a0001.js"><link rel="prefetch" href="/assets/js/66.6f92e582.js"><link rel="prefetch" href="/assets/js/67.9d51e14d.js"><link rel="prefetch" href="/assets/js/68.5675c3e2.js"><link rel="prefetch" href="/assets/js/69.e536d7ac.js"><link rel="prefetch" href="/assets/js/7.0dcc7463.js"><link rel="prefetch" href="/assets/js/70.e187963b.js"><link rel="prefetch" href="/assets/js/71.09bda95d.js"><link rel="prefetch" href="/assets/js/72.aefd789f.js"><link rel="prefetch" href="/assets/js/73.20936a8d.js"><link rel="prefetch" href="/assets/js/74.d17921e6.js"><link rel="prefetch" href="/assets/js/75.0ff9c5e9.js"><link rel="prefetch" href="/assets/js/76.479d210c.js"><link rel="prefetch" href="/assets/js/77.c5443f0d.js"><link rel="prefetch" href="/assets/js/78.666b2fe9.js"><link rel="prefetch" href="/assets/js/79.949a1f44.js"><link rel="prefetch" href="/assets/js/8.67e8e6f2.js"><link rel="prefetch" href="/assets/js/9.70c87633.js">
    <link rel="stylesheet" href="/assets/css/0.styles.da10bf32.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container reform"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="幺风" class="logo"> <span class="site-name can-hide">幺风</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><span class="reform-jia" style="font-size:1rem;"></span>
主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-zhi"></span> <span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link"><!---->
前端</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/" class="nav-link"><!---->
Flutter</a></li><li class="dropdown-item"><!----> <a href="/blog/coding/" class="nav-link"><!---->
学习思考</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/" class="nav-link"><!---->
算法与数据结构</a></li><li class="dropdown-item"><!----> <a href="/blog/reading/" class="nav-link"><!---->
阅读笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/reflection/" class="nav-link"><!---->
思考</a></li><li class="dropdown-item"><!----> <a href="/blog/canvas/" class="nav-link"><!---->
渲染相关</a></li><li class="dropdown-item"><!----> <a href="/blog/gesture/" class="nav-link router-link-active"><!---->
事件相关</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-shuben"></span> <span class="title">文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/vuepress-theme-reform.html" class="nav-link"><!---->
vuepress-theme-reform</a></li><li class="dropdown-item"><!----> <a href="/document/弹幕插件文档.html" class="nav-link"><!---->
弹幕插件文档</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><!---->
标签云</a></div><div class="nav-item"><a href="/about/" class="nav-link"><!---->
关于我</a></div> <a href="https://github.com/xuzhongpeng" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><span class="reform-jia" style="font-size:1rem;"></span>
主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-zhi"></span> <span class="title">博文</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontend/" class="nav-link"><!---->
前端</a></li><li class="dropdown-item"><!----> <a href="/blog/flutter/" class="nav-link"><!---->
Flutter</a></li><li class="dropdown-item"><!----> <a href="/blog/coding/" class="nav-link"><!---->
学习思考</a></li><li class="dropdown-item"><!----> <a href="/blog/algorithm/" class="nav-link"><!---->
算法与数据结构</a></li><li class="dropdown-item"><!----> <a href="/blog/reading/" class="nav-link"><!---->
阅读笔记</a></li><li class="dropdown-item"><!----> <a href="/blog/reflection/" class="nav-link"><!---->
思考</a></li><li class="dropdown-item"><!----> <a href="/blog/canvas/" class="nav-link"><!---->
渲染相关</a></li><li class="dropdown-item"><!----> <a href="/blog/gesture/" class="nav-link router-link-active"><!---->
事件相关</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="reform-shuben"></span> <span class="title">文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/vuepress-theme-reform.html" class="nav-link"><!---->
vuepress-theme-reform</a></li><li class="dropdown-item"><!----> <a href="/document/弹幕插件文档.html" class="nav-link"><!---->
弹幕插件文档</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><!---->
标签云</a></div><div class="nav-item"><a href="/about/" class="nav-link"><!---->
关于我</a></div> <a href="https://github.com/xuzhongpeng" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html" class="active sidebar-link">原始手势源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#原始事件获取" class="sidebar-link">原始事件获取</a></li><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#hittest-命中测试" class="sidebar-link">hitTest(命中测试)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#例子" class="sidebar-link">例子</a></li><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#hittestchildren" class="sidebar-link">hitTestChildren</a></li><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#hittestself" class="sidebar-link">hitTestSelf</a></li><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#behavior" class="sidebar-link">behavior</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#事件分发" class="sidebar-link">事件分发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#dispatchevent" class="sidebar-link">dispatchEvent</a></li><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#handleevent" class="sidebar-link">handleEvent</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/gesture/Flutter事件原理-原始事件源码解析.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/blog/gesture/Flutter事件原理-事件竞争.html" class="sidebar-link">手势冲突和手势竞争</a></li><li><a href="/blog/gesture/" class="sidebar-link">事件原理</a></li></ul> </aside> <main class="page" data-v-8958e280> <section class="tags" data-v-8958e280><span class="tagPopup" data-v-8958e280><a href="/tags/?tag=Flutter%E4%BA%8B%E4%BB%B6" class="tag" data-v-8958e280>Flutter事件</a></span></section> <div class="content theme-default-content content__default" data-v-8958e280><p>大前端最重要的两个事情，界面渲染和事件分发。下面我们通过源码和一些实例聊一聊Flutter的手势事件从接收到响应的整个过程。</p> <p>以下源代码基于</p> <blockquote><ul><li>Flutter 2.5.1</li> <li>Dart 2.14.2</li></ul></blockquote> <h2 id="原始事件获取"><a href="#原始事件获取" aria-hidden="true" class="header-anchor">#</a> 原始事件获取</h2> <p>在大前端中，大部分平台或系统原始指针处理方式都是类似的，按下、移动、抬起，其它高级事件如双击、滚动都是基于此来实现的。</p> <p>在Flutter中，接收事件的入口是从<code>_dispatchPointerDataPacket</code>开始的，通过绑定回调后面会调到<code>_handlePointerDataPacket</code>开始处理事件</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">void</span> <span class="token function">_handlePointerDataPacket</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>PointerDataPacket packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _pendingPointerEvents<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>PointerEventConverter<span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>data<span class="token punctuation">,</span> window<span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>locked<span class="token punctuation">)</span>
    <span class="token function">_flushPointerEventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>packet</code>是从引擎层过来的手势数据，其中<code>packet.data</code>是一个数组，如果在电脑PC上只有鼠标操作时它的长度是1，在移动端上比如我们按下屏幕会同时触发<code>hover</code>和<code>down</code>事件，它的长度是2，它的类型是<code>PointerData</code>，它有一些重要属性</p> <ul><li>change(PointerChange): 手势变化，如常见的<code>hover</code>、<code>down</code>、<code>move</code>、<code>up</code>等</li> <li>kind(PointerDeviceKind): 触发手势的装置，如<code>touch</code>(移动设备屏幕)、<code>mouse</code>(鼠标)等</li> <li>signalKind(PointerSignalKind): 除了手势外的响应方式，如鼠标滚轮滚动</li></ul> <p><code>PointerEventConverter.expand</code>会将原始获取的手势数据转化为<code>PointerEvent</code>类，不同手势类型会继承它实现不同的类</p> <ul><li>PointerCancelEvent: 手势取消，一般用于重置正在运行中的手势，可Native触发，也可以调用<code>cancelPointer</code>触发，经常用于当跳转新页面后，将原来页面正在运行的手势重置（混合开发时，经常会碰到Flutter页跳转到Native后返回，Flutter页面卡顿，就是手势没有正确取消，可以看我这篇文章<a href="https://juejin.cn/post/7024040068289396744" target="_blank" rel="noopener noreferrer">解决混合栈跳转导致Flutter页面事件卡死问题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>PointerDownEvent: 当手指或鼠标左键按下触发</li> <li>PointerMoveEvent: 当手指在屏幕上滑动或鼠标左键按下滑动触发</li> <li>PointerUpEvent: 当手指移出屏幕或鼠标左键抬起时触发</li> <li>PointerRemovedEvent: 当手势按下过程中移出到屏幕外触发</li> <li>PointerScrollEvent: 一般由鼠标滚轮触发</li> <li>PointerHoverEvent: 指针在屏幕上方时触发，常用于鼠标事件，触摸屏按下也会触发</li> <li>PointerEnterEvent: 指针进入某个区域时触发，常用于鼠标事件，由<code>PointerHoverEvent</code>事件触发计算获得</li> <li>PointerExitEvent: 鼠标移出某个区域时触发，常用于鼠标事件，由<code>PointerHoverEvent</code>事件触发计算获得</li></ul> <p><code>PointerEvent</code>也有一些重要的属性</p> <ul><li>embedderId(int): 平台唯一标识符</li> <li>pointer(int): 标识一次完整的手势，如手指按下、手指移动、手指抬起，当一次手势完成此标识会自增</li> <li>kind(PointerDeviceKind): 标识手势监听的设备，如手指、鼠标</li> <li>position(Offset): 指针相对于屏幕位置</li> <li>delta(Offset): 指针偏移量，目前只有<code>PointerHoverEvent</code>、<code>PointerMoveEvent</code>有偏移值</li> <li>buttons(int): 标识鼠标、手写笔等按键事件，比如按下鼠标右键时，触发<code>PointerDownEvent</code>同时buttons为<code>kSecondaryButton</code>，它是一个十六进制，Flutter定义了一些常量来标识，我以鼠标按键为例介绍一下
<ul><li>kPrimaryButton(0x01): 鼠标左键</li> <li>kSecondaryButton(0x02): 鼠标右键</li> <li>kTertiaryButton(0x04): 鼠标中键</li> <li>kBackMouseButton(0x08): 鼠标返回键</li> <li>kForwardMouseButton(0x08): 鼠标前进键</li></ul></li> <li>down(bool): 是否按下屏幕，如<code>PointerDownEvent</code>、<code>PointerMoveEvent</code>的down都为true</li></ul> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">void</span> <span class="token function">_flushPointerEventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>_pendingPointerEvents<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">)</span>
    <span class="token function">handlePointerEvent</span><span class="token punctuation">(</span>_pendingPointerEvents<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">handlePointerEvent</span><span class="token punctuation">(</span>PointerEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resamplingEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _resampler<span class="token punctuation">.</span><span class="token function">addOrDispatch</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _resampler<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span>samplingOffset<span class="token punctuation">,</span> _samplingClock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  _resampler<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_handlePointerEventImmediately</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>上面<code>_flushPointerEventQueue</code>很简单，就是循环遍历已经存入的指针列表，然后执行<code>handlePointerEvent</code>，<code>resamplingEnabled</code>为true的话表示在一些特殊设备上可以给<code>_handlePointerEventImmediately</code>添加一些延时来让手势更加顺畅。</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">void</span> <span class="token function">_handlePointerEventImmediately</span><span class="token punctuation">(</span>PointerEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HitTestResult<span class="token operator">?</span> hitTestResult<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerDownEvent <span class="token operator">||</span> event <span class="token operator">is</span> PointerSignalEvent <span class="token operator">||</span> event <span class="token operator">is</span> PointerHoverEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>_hitTests<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hitTestResult <span class="token operator">=</span> <span class="token function">HitTestResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hitTest</span><span class="token punctuation">(</span>hitTestResult<span class="token punctuation">,</span> event<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerDownEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _hitTests<span class="token punctuation">[</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">]</span> <span class="token operator">=</span> hitTestResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerUpEvent <span class="token operator">||</span> event <span class="token operator">is</span> PointerCancelEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hitTestResult <span class="token operator">=</span> _hitTests<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>down<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hitTestResult <span class="token operator">=</span> _hitTests<span class="token punctuation">[</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hitTestResult <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
      event <span class="token operator">is</span> PointerAddedEvent <span class="token operator">||</span>
      event <span class="token operator">is</span> PointerRemovedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>position <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> hitTestResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>_handlePointerEventImmediately</code>过程有几个部分，当<code>event is PointerDownEvent || event is PointerSignalEvent || event is PointerHoverEvent</code>时，会进行有<code>hitTest</code>过程，同时如果<code>event</code>是<code>PointerDownEvent</code>时，会将获得的<code>hitTest</code>结果缓存到<code>_hitTests</code>中。<code>hitTest</code>通常叫作<code>命中测试</code>，它是对事件发生范围内的组件进行收集，<code>PointerDownEvent</code>、<code>PointerSignalEvent</code>、<code>PointerHoverEvent</code>这三种类型的手势都是需要接触到屏幕且涉及到指针的变化.</p> <p>当<code>event is PointerUpEvent || event is PointerCancelEvent</code>时，代表一次手势的结束，所以它会将<code>result</code>从<code>_hitTests</code>中移除并赋值给<code>hitTestResult</code>，值得注意的是这里就是通过<code>pointer</code>属性来确定其对应的<code>PointerDownEvent</code>拿到的命中测试结果的。</p> <p>当<code>event.down</code>为<code>true</code>时，目前只有一种手势会进入到这里，就是<code>PointerMoveEvent</code>，为什么同样都是在屏幕上操作，它不应该也需要进行<code>hitTest</code>吗。在手势中，一般地『手指按下』、『手指移动』、『手指抬起』被认为是一次完整的手势过程，手指移动虽然位置会改变，但是它所作用的区域被认为还是在按下的区域，所以只要把按下区域的<code>result</code>拿来用就行了。</p> <h2 id="hittest-命中测试"><a href="#hittest-命中测试" aria-hidden="true" class="header-anchor">#</a> hitTest(命中测试)</h2> <p>在Flutter中，有个类似前端的事件冒泡机制叫<code>命中测试</code>(Hit Test)，它的作用是根据事件的位置收集所有在该位置上的Widget，它先从顶部节点开始对所有RenderObject(如果对RenderObject树不了解可以先看看我的另一篇<a href="https://jsshou.cn/blog/canvas/Flutter%E6%B8%B2%E6%9F%93%E4%B9%8BCompositingBits_paint_composite.html" target="_blank" rel="noopener noreferrer">文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)进行深度遍历，然后从最底层的节点开始向上将每个节点收集到一个为HitTestResult类型的result变量中，最后根据该result进行事件分发。</p> <h3 id="例子"><a href="#例子" aria-hidden="true" class="header-anchor">#</a> 例子</h3> <p>我以一个例子带大家看看<code>hitTest</code>过程Flutter底层到底做了些什么。</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string">'package:flutter/material.dart'</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runApp</span><span class="token punctuation">(</span><span class="token function">MyHomePage</span><span class="token punctuation">(</span>
    key<span class="token punctuation">:</span> <span class="token function">UniqueKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">MyHomePage</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">MyHomePage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Key<span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">ColoredBox</span><span class="token punctuation">(</span>
      color<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>white<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token function">Column</span><span class="token punctuation">(</span>
        mainAxisAlignment<span class="token punctuation">:</span> MainAxisAlignment<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Widget<span class="token operator">&gt;</span><span class="token punctuation">[</span>
          <span class="token function">Listener</span><span class="token punctuation">(</span>
            onPointerDown<span class="token punctuation">:</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'down'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token function">ColoredBox</span><span class="token punctuation">(</span>
              color<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>green<span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token function">SizedBox</span><span class="token punctuation">(</span>
                width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
                height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">Listener</span><span class="token punctuation">(</span>
            onPointerUp<span class="token punctuation">:</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'up'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token keyword">const</span> <span class="token function">ColoredBox</span><span class="token punctuation">(</span>
              color<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>yellow<span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token function">SizedBox</span><span class="token punctuation">(</span>
                width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
                height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>当我点击上面绿色的方块时，命中测试会有以下过程
<img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/hittest.gif" alt="hitTest"></p> <p>上面组件会生成如图中的<code>RenderObject</code>树，在<code>RendBinding</code>中会去调用<code>RenderView</code>的<code>hitTest</code>，<code>RenderView</code>会先对子组件进行收集，子组件是<code>_RenderColorBox</code>，在看<code>_RenderColorBox</code>的<code>hitTest</code>之前，我们先看看<code>RenderBox</code>的<code>hitTest</code>。</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>bool <span class="token function">hitTest</span><span class="token punctuation">(</span>BoxHitTestResult result<span class="token punctuation">,</span> <span class="token punctuation">{</span> required Offset position <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_size<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hitTestChildren</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> position<span class="token punctuation">:</span> position<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hitTestSelf</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">BoxHitTestEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>它先简单判断点击位置(position)是否在当前节点范围中(需要注意的是传入的position已经是经过转化相对于当前节点的位置了)，这是hitTest的关键，如果发生的事件不在组件范围，<code>hitTest</code>直接就失败了，就不用再遍历子组件了。</p> <h3 id="hittestchildren"><a href="#hittestchildren" aria-hidden="true" class="header-anchor">#</a> hitTestChildren</h3> <p>然后先调用<code>hitTestChildren</code>，它在这里很简单，作用是对子组件进行命中测试，如果子组件返回了true，说明子组件命中测试成功。</p> <p><code>hitTestChildren</code>默认返回false，因为可能当前组件没有子组件了。Flutter中比较典型的场景是当前组件存在一个子组件或多个子组件，当只有一个子组件时，大部分组件会使用<code>RenderProxyBoxMixin</code>这个<code>mixin</code>，比如<code>SizedBox</code>、<code>Opacity</code>、<code>ColoredBox</code>等，它的<code>hitTestChildren</code>是</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>bool <span class="token function">hitTestChildren</span><span class="token punctuation">(</span>BoxHitTestResult result<span class="token punctuation">,</span> <span class="token punctuation">{</span> required Offset position <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token keyword">return</span> child<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">hitTest</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> position<span class="token punctuation">:</span> position<span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>很简单，它直接调用子组件的<code>hitTest</code>。当有多个子组件时，比如<code>Column</code>、<code>Row</code>、<code>Stack</code>、<code>Wrap</code>、<code>ListBody</code>等，它们都是自己重写了<code>hitTestChildren</code>，然后直接调用了<code>RenderBoxContainerDefaultsMixin</code>中的<code>defaultHitTestChildren</code>这个方法</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>bool <span class="token function">defaultHitTestChildren</span><span class="token punctuation">(</span>BoxHitTestResult result<span class="token punctuation">,</span> <span class="token punctuation">{</span> required Offset position <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ChildType<span class="token operator">?</span> child <span class="token operator">=</span> lastChild<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> ParentDataType childParentData <span class="token operator">=</span> child<span class="token punctuation">.</span>parentData<span class="token operator">!</span> <span class="token operator">as</span> ParentDataType<span class="token punctuation">;</span>
    <span class="token keyword">final</span> bool isHit <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">addWithPaintOffset</span><span class="token punctuation">(</span>
      offset<span class="token punctuation">:</span> childParentData<span class="token punctuation">.</span>offset<span class="token punctuation">,</span>
      position<span class="token punctuation">:</span> position<span class="token punctuation">,</span>
      hitTest<span class="token punctuation">:</span> <span class="token punctuation">(</span>BoxHitTestResult result<span class="token punctuation">,</span> Offset<span class="token operator">?</span> transformed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>transformed <span class="token operator">==</span> position <span class="token operator">-</span> childParentData<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> child<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">hitTest</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> position<span class="token punctuation">:</span> transformed<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isHit<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    child <span class="token operator">=</span> childParentData<span class="token punctuation">.</span>previousSibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>简单解释一下，它是从最后一个子组件开始，向前遍历，<code>result.addWithPaintOffset</code>是计算当前子节点的偏移位置，因为传入的<code>position</code>是相对于父节点的偏移位置。如果一个子组件命中测试返回<code>true</code>，那么该<code>hitTestChildren</code>就直接返回<code>true</code>，不再遍历前面的组件了，这也是如果两个重叠的<code>Stack</code>子组件，上面的组件能接收到事件，而下面的组件接收不到事件的原因。</p> <p>如果我想让下面的组件也能接收到事件怎么办呢，这就是<code>behavior</code>属性该发挥作用了。</p> <h3 id="hittestself"><a href="#hittestself" aria-hidden="true" class="header-anchor">#</a> hitTestSelf</h3> <p>我们假设所有组件判断自己是否可通过命中测试都是依赖子组件，而看上面我们知道如果没有子组件，<code>hitTestChildren</code>会返回<code>false</code>，那就没有组件能通过命中测试，那么整个组件树<code>hitTest</code>都是返回<code>false</code>，<code>hitTestSelf</code>就是解决这个问题。</p> <p>在<code>hitTest</code>过程中，如果<code>hitTestSelf</code>返回<code>true</code>就是告诉它，我是能接收事件命中的，让我来响应手势事件吧。在Flutter组件中有很多组件是直接将<code>hitTestSelf</code>返回<code>true</code>的，如<code>MouseRegion</code>、<code>Texture</code>、<code>Image</code>、<code>EditableText</code>等组件的<code>RenderObject</code>对应的<code>hitTestSelf</code>。有些组件是需要简单的判断，如<code>Listener</code>、<code>ColoredBox</code>组件使用的<code>RenderProxyBoxWithHitTestBehavior</code>这个mixin</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>bool <span class="token function">hitTestSelf</span><span class="token punctuation">(</span>Offset position<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> behavior <span class="token operator">==</span> HitTestBehavior<span class="token punctuation">.</span>opaque<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它是通过<code>behavior</code>是否为<code>HitTestBehavior.opaque</code>来确定自己是否返回<code>true</code>。<code>behavior</code>这个东西又出现了，下面我们就来看看</p> <h3 id="behavior"><a href="#behavior" aria-hidden="true" class="header-anchor">#</a> behavior</h3> <p><code>hitTest</code>过程如果通过其实就做了两个事情，我们将这两个事情取名为<code>A</code>和<code>B</code>，<code>A</code>是将自己添加到<code>HitTestResult result</code>中，这样我就能响应事件了，二是告诉父组件的<code>hitTestChildren</code>返回<code>true</code>。从上面<code>RenderBox</code>中的<code>hitTest</code>我们可以看到，这两个事情都是同时发生的，那么有没有可能<code>A</code>发生<code>B</code>不发生。答案就在<code>RenderProxyBoxWithHitTestBehavior</code>这个mixin中。</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code>bool <span class="token function">hitTest</span><span class="token punctuation">(</span>BoxHitTestResult result<span class="token punctuation">,</span> <span class="token punctuation">{</span> required Offset position <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bool hitTarget <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hitTarget <span class="token operator">=</span> <span class="token function">hitTestChildren</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> position<span class="token punctuation">:</span> position<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hitTestSelf</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hitTarget <span class="token operator">||</span> behavior <span class="token operator">==</span> HitTestBehavior<span class="token punctuation">.</span>translucent<span class="token punctuation">)</span>
      result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">BoxHitTestEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> hitTarget<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
bool <span class="token function">hitTestSelf</span><span class="token punctuation">(</span>Offset position<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> behavior <span class="token operator">==</span> HitTestBehavior<span class="token punctuation">.</span>opaque<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>其中<code>behavior</code>这个属性发挥了重要的作用，它的类型<code>HitTestBehavior</code>是一个枚举，有三种情况</p> <ul><li>HitTestBehavior.deferToChild</li></ul> <p><code>deferToChild</code>是默认行为，事件在组件范围内发生时，当前组件是否添加进命中测试由其子组件来决定。也就是子组件通过测试它才通过，子组件会影响当前组件的命中结果。</p> <ul><li>HitTestBehavior.opaque</li></ul> <p><code>opaque</code>表示当事件在组件范围内发生时，不管子组件能否通过命中测试，当前组件都能通过。看上面<code>hitTestSelf</code>部分，只要<code>behavior</code>为<code>HitTestBehavior.opaque</code>，<code>hitTestSelf</code>就返回<code>true</code>。</p> <ul><li>HitTestBehavior.translucent</li></ul> <p><code>translucent</code>就是比较神奇的存在了，当子组件没有通过命中测试返回了<code>false</code>，当前组件也能将自己添加到<code>result</code>中，但是却告诉了父组件当前组件没有通过命中测试，也就是它做了<code>A</code>，却没有做<code>B</code>。</p> <p>它们分别有什么作用和区别呢，下面我们通过几个示例来看看<code>HitTestBehavior</code>几个属性的作用。</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runApp</span><span class="token punctuation">(</span><span class="token function">MyHomePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">MyHomePage</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">MyHomePage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Key<span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Center</span><span class="token punctuation">(</span>
      child<span class="token punctuation">:</span> <span class="token function">Listener</span><span class="token punctuation">(</span>
        onPointerDown<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;down&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token function">IgnorePointer</span><span class="token punctuation">(</span>
          child<span class="token punctuation">:</span> <span class="token function">ColoredBox</span><span class="token punctuation">(</span>
            color<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>red<span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token function">SizedBox</span><span class="token punctuation">(</span>
              width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
              height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>运行后会得到下面界面
<img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/51.png" alt="示例"></p> <p>简单解释一下这里<code>IgnorePointer</code>的作用，为了有点击区域的概念，我使用了<code>ColoredBox</code>和<code>SizedBox</code>，让界面中间出现一个红色区域，但<code>ColoredBox</code>它本身就能接收<code>hitTest</code>（<code>hitTestSelf</code>为true)，为了不受它的影响，我套了一个<code>IgnorePointer</code>让<code>Listener</code>子组件不能通过命中测试。</p> <p>上面<code>Listener</code>组件的<code>behavior</code>默认为<code>HitTestBehavior.deferToChild</code>，所以无论怎么点击红色区域，上面<code>onPointerDown</code>都不会有日志输出。</p> <p>我们稍微改一下</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token function">Listener</span><span class="token punctuation">(</span>
  behavior<span class="token punctuation">:</span> HitTestBehavior<span class="token punctuation">.</span>opaque<span class="token punctuation">,</span>
  onPointerDown<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;down&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//...</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>现在再来点击红色区域，发现输出了<code>down</code>的日志。在我们日常开发中，经常会遇到一个情况，我们使用<code>Container</code>组件没有设置颜色时，在它外层添加的<code>GestureDetector</code>点击范围可能只有在文字上，当我们给它设置了个透明色后就正常了，还是因为添加了颜色后，<code>Container</code>组件会嵌套一个<code>ColoredBox</code>，<code>ColoredBox</code>自己有通过命中测试的能力，所以就正常了，其实更好的做法是在<code>GestureDetector</code>上添加<code>HitTestBehavior.opaque</code>。</p> <p>我们再将上面例子改一下</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token keyword">class</span> <span class="token class-name">MyHomePage</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function">MyHomePage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Key<span class="token operator">?</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Center</span><span class="token punctuation">(</span>
      child<span class="token punctuation">:</span> <span class="token function">Stack</span><span class="token punctuation">(</span>
        textDirection<span class="token punctuation">:</span> TextDirection<span class="token punctuation">.</span>ltr<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token function">Listener</span><span class="token punctuation">(</span>
            behavior<span class="token punctuation">:</span> HitTestBehavior<span class="token punctuation">.</span>opaque<span class="token punctuation">,</span>
            onPointerDown<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;down1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token function">IgnorePointer</span><span class="token punctuation">(</span>
              child<span class="token punctuation">:</span> <span class="token function">ColoredBox</span><span class="token punctuation">(</span>
                color<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>red<span class="token punctuation">,</span>
                child<span class="token punctuation">:</span> <span class="token function">SizedBox</span><span class="token punctuation">(</span>
                  width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
                  height<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">Positioned</span><span class="token punctuation">(</span>
            top<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
            child<span class="token punctuation">:</span> <span class="token function">Listener</span><span class="token punctuation">(</span>
              behavior<span class="token punctuation">:</span> HitTestBehavior<span class="token punctuation">.</span>opaque<span class="token punctuation">,</span>
              onPointerDown<span class="token punctuation">:</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;down2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              child<span class="token punctuation">:</span> <span class="token function">IgnorePointer</span><span class="token punctuation">(</span>
                child<span class="token punctuation">:</span> <span class="token function">ColoredBox</span><span class="token punctuation">(</span>
                  color<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>blue<span class="token punctuation">,</span>
                  child<span class="token punctuation">:</span> <span class="token function">SizedBox</span><span class="token punctuation">(</span>
                    width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
                    height<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
                  <span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p><img src="https://vnode-1253495453.cos.ap-nanjing.myqcloud.com/29.png" alt=""></p> <p>下面蓝色方块是覆盖在红色方块上的，我们点击蓝色方块，会输出<code>down2</code>，但怎么都不会输出<code>down1</code>，如果我们将上面蓝色方块上的<code>behavior</code>设置成<code>HitTestBehavior.translucent</code>，将会输出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>down2
down1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这样，不仅蓝色方块接收到了down事件，而且事件还传递到了下面的红色方块上，让红色方块也接收到了事件。至于为什么是先<code>down2</code>再<code>down1</code>这个顺序，我们看看事件分发过程。</p> <h2 id="事件分发"><a href="#事件分发" aria-hidden="true" class="header-anchor">#</a> 事件分发</h2> <h3 id="dispatchevent"><a href="#dispatchevent" aria-hidden="true" class="header-anchor">#</a> dispatchEvent</h3> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token comment">// rendering/binding</span>
<span class="token metadata symbol">@override</span> <span class="token comment">// from GestureBinding</span>
<span class="token keyword">void</span> <span class="token function">dispatchEvent</span><span class="token punctuation">(</span>PointerEvent event<span class="token punctuation">,</span> HitTestResult<span class="token operator">?</span> hitTestResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理鼠标如`PointerExitEvent`、`PointerEnterEvent`等事件</span>
  _mouseTracker<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">updateWithEvent</span><span class="token punctuation">(</span>
    event<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>hitTestResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> event <span class="token operator">is</span> PointerMoveEvent<span class="token punctuation">)</span> <span class="token operator">?</span> renderView<span class="token punctuation">.</span><span class="token function">hitTestMouseTrackers</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token punctuation">:</span> hitTestResult<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> hitTestResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// gesturing/binding</span>
<span class="token keyword">void</span> <span class="token function">dispatchEvent</span><span class="token punctuation">(</span>PointerEvent event<span class="token punctuation">,</span> HitTestResult<span class="token operator">?</span> hitTestResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hitTestResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>event <span class="token operator">is</span> PointerAddedEvent <span class="token operator">||</span> event <span class="token operator">is</span> PointerRemovedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      pointerRouter<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">exception</span><span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> HitTestEntry entry <span class="token keyword">in</span> hitTestResult<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      entry<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">transformed</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>transform<span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">exception</span><span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>当<code>hitTestResult</code>为null，会进行<code>pointerRouter.route</code>，<code>pointerRouter</code>可以接收framework其它任何位置提供的回调，为引擎其它地方提供一个可以接收事件通知的能力。</p> <p>如果<code>hitTestResult</code>不为空，将会循环遍历命中测试拿到的<code>result</code>，执行其<code>handleEvent</code>方法。由于这里循环是数组从左往右执行，所以命中测试和事件分发是先进先出原则，这也就解释了为什么上面示例会先输出<code>down2</code>再输出<code>down1</code>。</p> <h3 id="handleevent"><a href="#handleevent" aria-hidden="true" class="header-anchor">#</a> handleEvent</h3> <p><code>handleEvent</code>是<code>HitTestTarget</code>上的方法，<code>RenderObject</code>实现了<code>HitTestTarget</code>，所以所有的<code>RenderObject</code>类及子类上都可以通过实现<code>handleEvent</code>来接收到事件响应。</p> <p>Flutter有很多组件自定义了<code>handleEvent</code>来处理比较复杂的事件，我们先先来看看<code>Listener</code>的<code>handleEvent</code></p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token metadata symbol">@override</span>
<span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>PointerEvent event<span class="token punctuation">,</span> HitTestEntry entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerDownEvent<span class="token punctuation">)</span>
    <span class="token keyword">return</span> onPointerDown<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerMoveEvent<span class="token punctuation">)</span>
    <span class="token keyword">return</span> onPointerMove<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerUpEvent<span class="token punctuation">)</span>
    <span class="token keyword">return</span> onPointerUp<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerHoverEvent<span class="token punctuation">)</span>
    <span class="token keyword">return</span> onPointerHover<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerCancelEvent<span class="token punctuation">)</span>
    <span class="token keyword">return</span> onPointerCancel<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerSignalEvent<span class="token punctuation">)</span>
    <span class="token keyword">return</span> onPointerSignal<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>它的实现很简单，就是根据事件类型直接返回给<code>Listener</code>传入的回调，所以<code>Listener</code>也可以叫做原始事件监听器，像我们常用的<code>GestureDetector</code>、<code>Scrollable</code>(<code>ListView</code>、<code>PageView</code>等都是基于它实现的)都是基于<code>Listener</code>实现的。</p> <p>再看看<code>GestureBinding</code>上<code>handleEvent</code>的实现</p> <div class="language-dart line-numbers-mode"><pre class="language-dart"><code><span class="token metadata symbol">@override</span> <span class="token comment">// from HitTestTarget</span>
<span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>PointerEvent event<span class="token punctuation">,</span> HitTestEntry entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pointerRouter<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerDownEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gestureArena<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerUpEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gestureArena<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">is</span> PointerSignalEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pointerSignalResolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>GestureBinding</code>是每次命中测试最后都会被添加到<code>HitTestResult result</code>中的，所以上面的<code>handleEvent</code>方法每次事件分发过程的最后都会执行一次，<code>pointerRouter.route</code>跟<code>hitTestResult</code>为null时一样。<code>gestureArena</code>提供一个手势竞争场，这个后面将<code>GestureDetector</code>组件时再细讲。<code>pointerSignalResolver</code>目前只是给鼠标滚轮事件使用的，鼠标滚轮事件没有竞争场概念，所以它提供一个能让鼠标事件能够竞争的机会，比如当多个如ListView嵌套时，当发生<code>PointerSignalEvent</code>事件时，所有ListView都会都滚动，这显然是不对的，<code>pointerSignalResolver</code>就能解决这个问题。</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>在Flutter中，当手指或鼠标接触屏幕到对应组件收到事件响应有两个过程，命中测试和事件分发，命中测试用于收集那些可以收到事件的组件，事件分发用于执行对应组件的接收事件函数，这样组件就可以在接收到事件后处理对应的逻辑。<code>Listener</code>是一个非常原始的事件监听组件，我们很多复杂的手势都可以基于它来实现。我突然想到一个问题，当我触摸移动一段距离再抬起时，<code>PointerDownEvent</code>、<code>PointerMoveEvent</code>、<code>PointerUpEvent</code>会依次触发，按照<code>Listener</code>组件，这时会同时触发点击事件和拖动事件，这显然不太合理，按照常理这时只会触发拖动事件，为了解决这个问题，Flutter引入了手势竞争的概念，我们后面再继续分析。</p></div> <footer class="page-edit" data-v-8958e280><!----> <div class="last-updated" data-v-8958e280><span class="prefix" data-v-8958e280>Last Updated:</span> <span class="time" data-v-8958e280>7/13/2022, 12:12:03 AM</span></div></footer> <div class="page-nav" data-v-8958e280><p class="inner" data-v-8958e280><!----> <span class="next" data-v-8958e280><a href="/blog/gesture/Flutter事件原理-事件竞争.html" data-v-8958e280>手势冲突和手势竞争</a>→
      </span></p></div> <div id="gitalk-container" data-v-8958e280></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f735c987.js" defer></script><script src="/assets/js/4.1b5f1a26.js" defer></script><script src="/assets/js/3.7354cf96.js" defer></script><script src="/assets/js/57.8fac4797.js" defer></script>
  </body>
</html>
